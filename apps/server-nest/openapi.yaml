openapi: 3.0.0
paths:
  /health:
    get:
      operationId: get
      parameters: []
      responses:
        '200':
          description: Health probe
          content:
            application/json:
              schema:
                example:
                  ok: true
                  model: text-embedding-004
                  db: up
                  embeddings: enabled
                  rls_policies_ok: true
                  rls_policy_count: 8
                  rls_policy_hash: policies:123:1a2b
        '400':
          description: Bad request
          content:
            application/json:
              schema:
                example:
                  error:
                    code: bad-request
                    message: Invalid request
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                example:
                  error:
                    code: internal
                    message: Unexpected error
      tags:
        - Health
  /auth/me:
    get:
      operationId: me
      parameters: []
      responses:
        '200':
          description: Return current authenticated user (mock)
          content:
            application/json:
              schema:
                example:
                  sub: mock-user-id
                  email: demo@example.com
        '400':
          description: Bad request
          content:
            application/json:
              schema:
                example:
                  error:
                    code: bad-request
                    message: Invalid request
        '401':
          description: Missing or invalid bearer token
          content:
            application/json:
              schema:
                example:
                  error:
                    code: unauthorized
                    message: Unauthorized
        '403':
          description: Insufficient scope
          content:
            application/json:
              schema:
                example:
                  error:
                    code: forbidden
                    message: Forbidden
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                example:
                  error:
                    code: internal
                    message: Unexpected error
      tags:
        - Auth
      security:
        - bearer: []
  /settings:
    get:
      operationId: list
      parameters: []
      responses:
        '200':
          description: List settings (placeholder)
          content:
            application/json:
              schema:
                example:
                  - key: theme
                    value: dark
        '400':
          description: Bad request
          content:
            application/json:
              schema:
                example:
                  error:
                    code: bad-request
                    message: Invalid request
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                example:
                  error:
                    code: unauthorized
                    message: Missing or invalid credentials
        '403':
          description: Forbidden
          content:
            application/json:
              schema:
                example:
                  error:
                    code: forbidden
                    message: Insufficient permissions
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                example:
                  error:
                    code: internal
                    message: Unexpected error
      tags: &ref_0
        - Settings
  /settings/{key}:
    get:
      operationId: getOne
      parameters:
        - name: key
          required: true
          in: path
          schema:
            type: string
      responses:
        '200':
          description: Get a single setting (placeholder)
          content:
            application/json:
              schema:
                example:
                  key: theme
                  value: dark
        '400':
          description: Bad request
          content:
            application/json:
              schema:
                example:
                  error:
                    code: bad-request
                    message: Invalid request
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                example:
                  error:
                    code: unauthorized
                    message: Missing or invalid credentials
        '403':
          description: Forbidden
          content:
            application/json:
              schema:
                example:
                  error:
                    code: forbidden
                    message: Insufficient permissions
        '404':
          description: Setting not found
          content:
            application/json:
              schema:
                example:
                  error:
                    code: not-found
                    message: Setting not found
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                example:
                  error:
                    code: internal
                    message: Unexpected error
      tags: *ref_0
  /orgs:
    get:
      operationId: list
      parameters: []
      responses:
        '200':
          description: List organizations
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/OrgDto'
        '400':
          description: Bad request
          content:
            application/json:
              schema:
                example:
                  error:
                    code: bad-request
                    message: Invalid filter
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                example:
                  error:
                    code: unauthorized
                    message: Missing or invalid credentials
        '403':
          description: Forbidden
          content:
            application/json:
              schema:
                example:
                  error:
                    code: forbidden
                    message: Insufficient permissions
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                example:
                  error:
                    code: internal
                    message: Unexpected error
      tags: &ref_1
        - Orgs
    post:
      operationId: create
      parameters: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateOrgDto'
      responses:
        '201':
          description: Organization created (users may have at most 10 orgs)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OrgDto'
        '400':
          description: Invalid body
          content:
            application/json:
              schema:
                example:
                  error:
                    code: validation-failed
                    message: Validation failed
                    details:
                      name:
                        - must be a string
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                example:
                  error:
                    code: unauthorized
                    message: Missing or invalid credentials
        '403':
          description: Forbidden
          content:
            application/json:
              schema:
                example:
                  error:
                    code: forbidden
                    message: Insufficient permissions
        '409':
          description: Organization limit reached or duplicate name
          content:
            application/json:
              schema:
                oneOf:
                  - example:
                      error:
                        code: conflict
                        message: Organization limit reached (10)
                  - example:
                      error:
                        code: conflict
                        message: Organization name already exists
                        details:
                          name:
                            - already exists
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                example:
                  error:
                    code: internal
                    message: Unexpected error
      tags: *ref_1
  /orgs/{id}:
    get:
      operationId: getOne
      parameters:
        - name: id
          required: true
          in: path
          schema:
            type: string
      responses:
        '200':
          description: Get an organization
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OrgDto'
        '400':
          description: Bad request
          content:
            application/json:
              schema:
                example:
                  error:
                    code: bad-request
                    message: Invalid request
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                example:
                  error:
                    code: unauthorized
                    message: Missing or invalid credentials
        '403':
          description: Forbidden
          content:
            application/json:
              schema:
                example:
                  error:
                    code: forbidden
                    message: Insufficient permissions
        '404':
          description: Org not found
          content:
            application/json:
              schema:
                example:
                  error:
                    code: not-found
                    message: Org not found
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                example:
                  error:
                    code: internal
                    message: Unexpected error
      tags: *ref_1
    delete:
      operationId: delete
      parameters:
        - name: id
          required: true
          in: path
          schema:
            type: string
      responses:
        '200':
          description: >-
            Organization deleted (projects, documents, chunks, conversations
            cascade)
        '400':
          description: Bad request
          content:
            application/json:
              schema:
                example:
                  error:
                    code: bad-request
                    message: Invalid request
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                example:
                  error:
                    code: unauthorized
                    message: Missing or invalid credentials
        '403':
          description: Forbidden
          content:
            application/json:
              schema:
                example:
                  error:
                    code: forbidden
                    message: Insufficient permissions
        '404':
          description: Org not found
          content:
            application/json:
              schema:
                example:
                  error:
                    code: not-found
                    message: Org not found
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                example:
                  error:
                    code: internal
                    message: Unexpected error
      tags: *ref_1
  /projects:
    get:
      operationId: list
      parameters:
        - name: limit
          required: true
          in: query
          schema:
            type: string
        - name: orgId
          required: false
          in: query
          description: >-
            Filter projects by organization id (must be explicit elsewhere when
            creating projects)
          schema:
            type: string
      responses:
        '200':
          description: List projects (must create at least one before ingesting documents)
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/ProjectDto'
        '400':
          description: Bad request
          content:
            application/json:
              schema:
                example:
                  error:
                    code: bad-request
                    message: Invalid filter
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                example:
                  error:
                    code: unauthorized
                    message: Missing or invalid credentials
        '403':
          description: Forbidden
          content:
            application/json:
              schema:
                example:
                  error:
                    code: forbidden
                    message: Insufficient permissions
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                example:
                  error:
                    code: internal
                    message: Unexpected error
      tags: &ref_2
        - Projects
    post:
      operationId: create
      parameters: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateProjectDto'
      responses:
        '201':
          description: Project created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProjectDto'
        '400':
          description: Validation / duplicate / org errors
          content:
            application/json:
              schema:
                example:
                  error:
                    code: duplicate
                    message: Project with this name exists in org
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                example:
                  error:
                    code: unauthorized
                    message: Missing or invalid credentials
        '403':
          description: Forbidden
          content:
            application/json:
              schema:
                example:
                  error:
                    code: forbidden
                    message: Insufficient permissions
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                example:
                  error:
                    code: internal
                    message: Unexpected error
      tags: *ref_2
  /projects/{id}:
    delete:
      operationId: delete
      parameters:
        - name: id
          required: true
          in: path
          schema:
            type: string
      responses:
        '200':
          description: Deleted project
          content:
            application/json:
              schema:
                example:
                  status: deleted
        '400':
          description: Invalid id
          content:
            application/json:
              schema:
                example:
                  error:
                    code: bad-request
                    message: Invalid id
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                example:
                  error:
                    code: unauthorized
                    message: Missing or invalid credentials
        '403':
          description: Forbidden
          content:
            application/json:
              schema:
                example:
                  error:
                    code: forbidden
                    message: Insufficient permissions
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                example:
                  error:
                    code: internal
                    message: Unexpected error
      tags: *ref_2
  /search:
    get:
      operationId: search
      parameters:
        - name: q
          required: true
          in: query
          description: Query string
          schema:
            example: vector index design
            type: string
        - name: limit
          required: false
          in: query
          description: Result limit (1..50)
          schema:
            minimum: 1
            maximum: 50
            default: 10
            type: number
        - name: mode
          required: false
          in: query
          schema:
            default: hybrid
            enum:
              - hybrid
              - lexical
              - vector
            type: string
      responses:
        '200':
          description: Hybrid / lexical / vector search over chunks
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SearchResponseDto'
        '400':
          description: Validation failed
          content:
            application/json:
              schema:
                example:
                  error:
                    code: validation-failed
                    message: Validation failed
                    details:
                      q:
                        - must be longer than or equal to 1 characters
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                example:
                  error:
                    code: unauthorized
                    message: Missing or invalid credentials
        '403':
          description: Forbidden
          content:
            application/json:
              schema:
                example:
                  error:
                    code: forbidden
                    message: Insufficient permissions
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                example:
                  error:
                    code: internal
                    message: Unexpected error
      tags:
        - Search
  /documents:
    get:
      operationId: list
      parameters:
        - name: limit
          required: false
          in: query
          schema:
            type: number
            minimum: 1
            maximum: 500
            default: 100
        - name: cursor
          required: true
          in: query
          schema:
            type: string
      responses:
        '200':
          description: List ingested documents
          headers:
            x-next-cursor:
              description: Base64 cursor for next page
              schema:
                type: string
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/DocumentDto'
        '400':
          description: Bad request
          content:
            application/json:
              schema:
                example:
                  error:
                    code: bad-request
                    message: Invalid filter
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                example:
                  error:
                    code: unauthorized
                    message: Missing or invalid credentials
        '403':
          description: Forbidden
          content:
            application/json:
              schema:
                example:
                  error:
                    code: forbidden
                    message: Insufficient permissions
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                example:
                  error:
                    code: internal
                    message: Unexpected error
      tags: &ref_3
        - Documents
    post:
      operationId: create
      parameters: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              properties:
                filename:
                  type: string
                projectId:
                  type: string
                  format: uuid
                content:
                  type: string
      responses:
        '200':
          description: Created document
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DocumentDto'
        '400':
          description: Bad request
          content:
            application/json:
              schema:
                example:
                  error:
                    code: bad-request
                    message: Invalid request
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                example:
                  error:
                    code: unauthorized
                    message: Missing or invalid credentials
        '403':
          description: Forbidden
          content:
            application/json:
              schema:
                example:
                  error:
                    code: forbidden
                    message: Insufficient permissions
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                example:
                  error:
                    code: internal
                    message: Unexpected error
      tags: *ref_3
  /documents/{id}:
    get:
      operationId: get
      parameters:
        - name: id
          required: true
          in: path
          description: Document UUID
          schema:
            type: string
      responses:
        '200':
          description: Get a document
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DocumentDto'
        '400':
          description: Bad request
          content:
            application/json:
              schema:
                example:
                  error:
                    code: bad-request
                    message: Invalid id
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                example:
                  error:
                    code: unauthorized
                    message: Missing or invalid credentials
        '403':
          description: Forbidden
          content:
            application/json:
              schema:
                example:
                  error:
                    code: forbidden
                    message: Insufficient permissions
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                example:
                  error:
                    code: internal
                    message: Unexpected error
      tags: *ref_3
    delete:
      operationId: delete
      parameters:
        - name: id
          required: true
          in: path
          schema:
            type: string
      responses:
        '200':
          description: ''
      tags: *ref_3
  /chunks:
    get:
      operationId: list
      parameters:
        - name: documentId
          required: false
          in: query
          description: Filter by document UUID
          schema:
            type: string
      responses:
        '200':
          description: List chunks
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/ChunkDto'
        '400':
          description: Bad request
          content:
            application/json:
              schema:
                example:
                  error:
                    code: bad-request
                    message: Invalid filter
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                example:
                  error:
                    code: unauthorized
                    message: Missing or invalid credentials
        '403':
          description: Forbidden
          content:
            application/json:
              schema:
                example:
                  error:
                    code: forbidden
                    message: Insufficient permissions
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                example:
                  error:
                    code: internal
                    message: Unexpected error
      tags:
        - Chunks
  /ingest/upload:
    post:
      operationId: upload
      parameters: []
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              $ref: '#/components/schemas/IngestionUploadDto'
      responses:
        '200':
          description: Upload a file for ingestion
          content:
            application/json:
              schema:
                example:
                  documentId: 11111111-2222-3333-4444-555555555555
                  chunks: 12
                  alreadyExists: false
        '400':
          description: Invalid upload payload
          content:
            application/json:
              schema:
                example:
                  error:
                    code: validation-failed
                    message: Validation failed
                    details:
                      filename:
                        - must be a string
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                example:
                  error:
                    code: unauthorized
                    message: Missing or invalid credentials
        '403':
          description: Forbidden
          content:
            application/json:
              schema:
                example:
                  error:
                    code: forbidden
                    message: Insufficient permissions
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                example:
                  error:
                    code: internal
                    message: Unexpected error
      tags: &ref_4
        - Ingestion
  /ingest/url:
    post:
      operationId: ingestUrl
      parameters: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/IngestionUrlDto'
      responses:
        '200':
          description: Ingest a remote URL
          content:
            application/json:
              schema:
                example:
                  documentId: aaaaaaaa-bbbb-cccc-dddd-eeeeeeeeeeee
                  chunks: 8
                  alreadyExists: false
        '400':
          description: Invalid URL payload
          content:
            application/json:
              schema:
                example:
                  error:
                    code: validation-failed
                    message: Validation failed
                    details:
                      url:
                        - must be an URL address
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                example:
                  error:
                    code: unauthorized
                    message: Missing or invalid credentials
        '403':
          description: Forbidden
          content:
            application/json:
              schema:
                example:
                  error:
                    code: forbidden
                    message: Insufficient permissions
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                example:
                  error:
                    code: internal
                    message: Unexpected error
      tags: *ref_4
  /chat/conversations:
    get:
      operationId: listConversations
      parameters: []
      responses:
        '200':
          description: List chat conversations
          content:
            application/json:
              schema:
                example:
                  - id: 11111111-1111-4111-8111-111111111111
                    title: 2025-01-01 — Hello world
                    is_private: false
        '400':
          description: Bad request
          content:
            application/json:
              schema:
                example:
                  error:
                    code: bad-request
                    message: Invalid request
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                example:
                  error:
                    code: unauthorized
                    message: Missing or invalid credentials
        '403':
          description: Forbidden
          content:
            application/json:
              schema:
                example:
                  error:
                    code: forbidden
                    message: Insufficient permissions
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                example:
                  error:
                    code: internal
                    message: Unexpected error
      tags: &ref_5
        - Chat
    post:
      operationId: createConversation
      parameters: []
      responses:
        '200':
          description: Create a new conversation (201)
          content:
            application/json:
              schema:
                example:
                  conversationId: 11111111-1111-4111-8111-111111111111
                  id: 11111111-1111-4111-8111-111111111111
                  title: 2025-01-01 — New Conversation
        '400':
          description: Bad request
          content:
            application/json:
              schema:
                example:
                  error:
                    code: bad-request
                    message: message required
      tags: *ref_5
  /chat/{id}:
    get:
      operationId: getConversation
      parameters:
        - name: id
          required: true
          in: path
          schema:
            type: string
      responses:
        '200':
          description: Get a conversation with messages
        '400':
          description: Bad request
          content:
            application/json:
              schema:
                example:
                  error:
                    code: bad-request
                    message: Invalid request
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                example:
                  error:
                    code: unauthorized
                    message: Missing or invalid credentials
        '403':
          description: Forbidden
          content:
            application/json:
              schema:
                example:
                  error:
                    code: forbidden
                    message: Forbidden
        '404':
          description: Conversation not found
          content:
            application/json:
              schema:
                example:
                  error:
                    code: not-found
                    message: Conversation not found
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                example:
                  error:
                    code: internal
                    message: Unexpected error
      tags: *ref_5
    patch:
      operationId: rename
      parameters:
        - name: id
          required: true
          in: path
          schema:
            type: string
      responses:
        '200':
          description: Rename conversation
          content:
            application/json:
              schema:
                example:
                  ok: true
                  id: c1
                  title: New Title
        '400':
          description: Bad request
          content:
            application/json:
              schema:
                example:
                  error:
                    code: bad-request
                    message: title required
        '404':
          description: Conversation not found
          content:
            application/json:
              schema:
                example:
                  error:
                    code: not-found
                    message: Conversation not found
      tags: *ref_5
    delete:
      operationId: delete
      parameters:
        - name: id
          required: true
          in: path
          schema:
            type: string
      responses:
        '200':
          description: Delete conversation
          content:
            application/json:
              schema:
                example:
                  ok: true
                  id: c1
        '404':
          description: Conversation not found
          content:
            application/json:
              schema:
                example:
                  error:
                    code: not-found
                    message: Conversation not found
      tags: *ref_5
  /chat/{id}/stream:
    get:
      operationId: streamGet
      parameters:
        - name: id
          required: true
          in: path
          schema:
            type: string
      responses:
        '200':
          description: >-
            Chat streaming endpoint (SSE). Emits a sequence of JSON frames each
            prefixed by "data: ".
          content:
            text/event-stream:
              schema:
                oneOf:
                  - $ref: '#/components/schemas/GetChatStreamMetaFrame'
                  - $ref: '#/components/schemas/GetChatStreamTokenFrame'
                  - $ref: '#/components/schemas/GetChatStreamCitationsFrame'
                  - $ref: '#/components/schemas/GetChatStreamSummaryFrame'
                  - $ref: '#/components/schemas/GetChatStreamDoneFrame'
                  - $ref: '#/components/schemas/GetChatStreamErrorFrame'
              examples:
                meta:
                  value: |+
                    data: {"meta":{"chat_model_enabled":true,"google_key":true}}

                token:
                  value: |+
                    data: {"message":"token-0","index":0,"streaming":true}

                citations:
                  value: >+
                    data:
                    {"citations":[{"documentId":"11111111-1111-4111-8111-111111111111"}]}

                summary:
                  value: |+
                    data: {"summary":true,"token_count":5,"citations_count":2}

                done:
                  value: |+
                    data: {"done":true,"message":"[DONE]"}

                error:
                  value: >+
                    data:
                    {"error":{"code":"upstream-failed","message":"Simulated
                    upstream model failure"},"done":true}

        '400':
          description: Missing project header
          content:
            text/event-stream:
              schema:
                example:
                  error:
                    code: bad-request
                    message: x-project-id header required
        '404':
          description: Conversation not found
          content:
            text/event-stream:
              schema:
                example:
                  error:
                    code: not-found
                    message: Conversation not found
      tags: *ref_5
  /chat/stream:
    post:
      operationId: streamPost
      parameters: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ChatRequestDto'
      responses:
        '200':
          description: >-
            Chat streaming endpoint (SSE). Each line is an SSE data frame
            beginning with "data: ", followed by one of the JSON event shapes.
          content:
            text/event-stream:
              schema:
                oneOf:
                  - $ref: '#/components/schemas/ChatStreamMetaEvent'
                  - $ref: '#/components/schemas/ChatStreamTokenEvent'
                  - $ref: '#/components/schemas/ChatStreamErrorEvent'
                  - $ref: '#/components/schemas/ChatStreamDoneEvent'
                description: >-
                  Union of possible chat stream events (serialized per line as
                  SSE frame).
              examples:
                meta:
                  value: >+
                    data:
                    {"type":"meta","conversationId":"11111111-1111-4111-8111-111111111111","citations":[]}

                token:
                  value: |+
                    data: {"type":"token","token":"Hello"}

                error:
                  value: |+
                    data: {"type":"error","error":"model key missing"}

                done:
                  value: |+
                    data: {"type":"done"}

        '400':
          description: Bad request
          content:
            text/event-stream:
              schema:
                example:
                  error:
                    code: bad-request
                    message: message required
        '401':
          description: Unauthorized
          content:
            text/event-stream:
              schema:
                example:
                  error:
                    code: unauthorized
                    message: Missing or invalid credentials
        '403':
          description: Forbidden
          content:
            text/event-stream:
              schema:
                example:
                  error:
                    code: forbidden
                    message: Insufficient permissions
        '500':
          description: Internal server error
          content:
            text/event-stream:
              schema:
                example:
                  error:
                    code: internal
                    message: Unexpected error
      tags: *ref_5
  /invites:
    post:
      operationId: create
      parameters: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateInviteDto'
      responses:
        '201':
          description: ''
  /invites/accept:
    post:
      operationId: accept
      parameters: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AcceptInviteDto'
      responses:
        '201':
          description: ''
  /user/profile:
    get:
      operationId: getSelf
      parameters: []
      responses:
        '200':
          description: ''
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserProfileDto'
        '400':
          description: Bad request
          content:
            application/json:
              schema:
                example:
                  error:
                    code: bad-request
                    message: Invalid request
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                example:
                  error:
                    code: unauthorized
                    message: Missing or invalid credentials
        '403':
          description: Forbidden
          content:
            application/json:
              schema:
                example:
                  error:
                    code: forbidden
                    message: Insufficient permissions
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                example:
                  error:
                    code: internal
                    message: Unexpected error
      tags: &ref_6
        - UserProfile
    put:
      operationId: updateSelf
      parameters: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateUserProfileDto'
      responses:
        '200':
          description: ''
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserProfileDto'
        '400':
          description: Validation error
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                example:
                  error:
                    code: unauthorized
                    message: Missing or invalid credentials
        '403':
          description: Forbidden
          content:
            application/json:
              schema:
                example:
                  error:
                    code: forbidden
                    message: Insufficient permissions
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                example:
                  error:
                    code: internal
                    message: Unexpected error
      tags: *ref_6
  /user/profile/emails:
    get:
      operationId: listEmails
      parameters: []
      responses:
        '200':
          description: ''
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/AlternativeEmailDto'
        '400':
          description: Bad request
          content:
            application/json:
              schema:
                example:
                  error:
                    code: bad-request
                    message: Invalid request
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                example:
                  error:
                    code: unauthorized
                    message: Missing or invalid credentials
        '403':
          description: Forbidden
          content:
            application/json:
              schema:
                example:
                  error:
                    code: forbidden
                    message: Insufficient permissions
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                example:
                  error:
                    code: internal
                    message: Unexpected error
      tags: *ref_6
    post:
      operationId: addEmail
      parameters: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AddAlternativeEmailDto'
      responses:
        '200':
          description: ''
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AlternativeEmailDto'
        '400':
          description: Bad request
          content:
            application/json:
              schema:
                example:
                  error:
                    code: bad-request
                    message: Invalid request
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                example:
                  error:
                    code: unauthorized
                    message: Missing or invalid credentials
        '403':
          description: Forbidden
          content:
            application/json:
              schema:
                example:
                  error:
                    code: forbidden
                    message: Insufficient permissions
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                example:
                  error:
                    code: internal
                    message: Unexpected error
      tags: *ref_6
  /user/profile/emails/{email}:
    delete:
      operationId: removeEmail
      parameters:
        - name: email
          required: true
          in: path
          schema:
            type: string
      responses:
        '200':
          description: ''
          content:
            application/json:
              schema:
                example:
                  status: deleted
        '400':
          description: Bad request
          content:
            application/json:
              schema:
                example:
                  error:
                    code: bad-request
                    message: Invalid request
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                example:
                  error:
                    code: unauthorized
                    message: Missing or invalid credentials
        '403':
          description: Forbidden
          content:
            application/json:
              schema:
                example:
                  error:
                    code: forbidden
                    message: Insufficient permissions
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                example:
                  error:
                    code: internal
                    message: Unexpected error
      tags: *ref_6
  /graph/objects:
    post:
      operationId: create
      summary: Create a graph object (initial version)
      parameters: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateGraphObjectDto'
      responses:
        '201':
          description: Created
        '400':
          description: Validation error
      tags: &ref_7
        - Graph
  /graph/objects/search:
    get:
      operationId: searchObjects
      summary: Search graph objects (basic filters)
      description: >-
        Supports pagination via created_at cursor. Optional order param
        (asc|desc) controls chronological direction (default asc). Desc returns
        newest first; cursor always set to last item created_at in current page.
      parameters:
        - name: type
          required: true
          in: query
          schema:
            type: string
        - name: key
          required: true
          in: query
          schema:
            type: string
        - name: label
          required: true
          in: query
          schema:
            type: string
        - name: limit
          required: true
          in: query
          schema:
            type: string
        - name: cursor
          required: true
          in: query
          schema:
            type: string
        - name: order
          required: false
          in: query
          description: >-
            Chronological direction (asc=oldest→newest, desc=newest→oldest).
            Default asc.
          schema:
            enum:
              - asc
              - desc
            type: string
      responses:
        '200':
          description: ''
      tags: *ref_7
  /graph/objects/fts:
    get:
      operationId: ftsSearch
      summary: Full-text search graph objects
      description: >-
        Websearch syntax over inline-populated tsvector (type, key, properties
        JSON). Returns newest heads ranked by ts_rank. Supports optional type,
        label, branch_id filters. Limit max 100.
      parameters:
        - name: q
          required: true
          in: query
          description: Search query (websearch syntax)
          schema:
            type: string
        - name: limit
          required: true
          in: query
          schema:
            type: string
        - name: type
          required: true
          in: query
          schema:
            type: string
        - name: label
          required: true
          in: query
          schema:
            type: string
        - name: branch_id
          required: true
          in: query
          schema:
            type: string
      responses:
        '200':
          description: ''
      tags: *ref_7
  /graph/objects/{id}:
    get:
      operationId: get
      summary: Get latest version of a graph object
      parameters:
        - name: id
          required: true
          in: path
          schema:
            type: string
      responses:
        '200':
          description: ''
        '404':
          description: Not found
      tags: *ref_7
    patch:
      operationId: patch
      summary: Patch (create new version) of a graph object
      parameters:
        - name: id
          required: true
          in: path
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PatchGraphObjectDto'
      responses:
        '200':
          description: Version created
        '400':
          description: No effective change
        '404':
          description: Not found
      tags: *ref_7
    delete:
      operationId: deleteObject
      summary: Soft delete (tombstone) an object (creates new version with deleted_at)
      parameters:
        - name: id
          required: true
          in: path
          schema:
            type: string
      responses:
        '200':
          description: ''
      tags: *ref_7
  /graph/objects/{id}/restore:
    post:
      operationId: restoreObject
      summary: Restore a soft-deleted object (creates new version clearing deleted_at)
      parameters:
        - name: id
          required: true
          in: path
          schema:
            type: string
      responses:
        '201':
          description: Restored (new version created)
      tags: *ref_7
  /graph/objects/{id}/history:
    get:
      operationId: history
      summary: List version history for a graph object
      parameters:
        - name: id
          required: true
          in: path
          schema:
            type: string
        - name: limit
          required: true
          in: query
          schema:
            type: string
        - name: cursor
          required: true
          in: query
          schema:
            type: string
      responses:
        '200':
          description: ''
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ObjectHistoryResponseDto'
        '404':
          description: Not found
      tags: *ref_7
  /graph/relationships:
    post:
      operationId: createRel
      summary: >-
        Create a relationship (initial version) or new version if properties
        changed
      parameters: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateGraphRelationshipDto'
      responses:
        '201':
          description: ''
      tags: *ref_7
  /graph/relationships/{id}:
    get:
      operationId: getRel
      summary: Get relationship by id
      parameters:
        - name: id
          required: true
          in: path
          schema:
            type: string
      responses:
        '200':
          description: ''
      tags: *ref_7
    patch:
      operationId: patchRel
      summary: Patch (create new version) of a relationship (only head version allowed)
      parameters:
        - name: id
          required: true
          in: path
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PatchGraphRelationshipDto'
      responses:
        '200':
          description: ''
      tags: *ref_7
    delete:
      operationId: deleteRel
      summary: Soft delete a relationship (tombstone version)
      parameters:
        - name: id
          required: true
          in: path
          schema:
            type: string
      responses:
        '200':
          description: ''
      tags: *ref_7
  /graph/relationships/search:
    get:
      operationId: searchRels
      summary: Search relationships (basic filters)
      description: >-
        Supports pagination via created_at cursor. Optional order param
        (asc|desc) for chronological direction (default asc).
      parameters:
        - name: type
          required: true
          in: query
          schema:
            type: string
        - name: src_id
          required: true
          in: query
          schema:
            type: string
        - name: dst_id
          required: true
          in: query
          schema:
            type: string
        - name: limit
          required: true
          in: query
          schema:
            type: string
        - name: cursor
          required: true
          in: query
          schema:
            type: string
        - name: order
          required: false
          in: query
          description: >-
            Chronological direction (asc=oldest→newest, desc=newest→oldest).
            Default asc.
          schema:
            enum:
              - asc
              - desc
            type: string
      responses:
        '200':
          description: ''
      tags: *ref_7
  /graph/relationships/{id}/restore:
    post:
      operationId: restoreRel
      summary: Restore a soft-deleted relationship
      parameters:
        - name: id
          required: true
          in: path
          schema:
            type: string
      responses:
        '201':
          description: Restored (new version created)
      tags: *ref_7
  /graph/relationships/{id}/history:
    get:
      operationId: historyRel
      summary: List version history for a relationship
      parameters:
        - name: id
          required: true
          in: path
          schema:
            type: string
        - name: limit
          required: true
          in: query
          schema:
            type: string
        - name: cursor
          required: true
          in: query
          schema:
            type: string
      responses:
        '200':
          description: ''
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RelationshipHistoryResponseDto'
      tags: *ref_7
  /graph/objects/{id}/edges:
    get:
      operationId: edges
      summary: List relationships adjacent to an object
      parameters:
        - name: id
          required: true
          in: path
          schema:
            type: string
        - name: direction
          required: true
          in: query
          schema:
            type: string
        - name: limit
          required: true
          in: query
          schema:
            type: string
      responses:
        '200':
          description: ''
      tags: *ref_7
  /graph/traverse:
    post:
      operationId: traverse
      summary: Traverse the graph from one or more root object ids (bounded BFS)
      parameters: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/TraverseGraphDto'
      responses:
        '200':
          description: ''
      tags: *ref_7
  /graph/expand:
    post:
      operationId: expand
      summary: >-
        Expand graph (single-pass bounded traversal with projection & edge
        property option)
      parameters: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/GraphExpandDto'
      responses:
        '200':
          description: ''
      tags: *ref_7
  /graph/objects/vector-search:
    post:
      operationId: vectorSearch
      summary: Vector similarity search
      description: >-
        Returns nearest neighbors (cosine distance) for provided query vector
        over embedding_vec. Threshold: use maxDistance (preferred) or legacy
        minScore (acts as maximum distance). When both are supplied, maxDistance
        takes precedence.
      parameters: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/VectorSearchDto'
      responses:
        '200':
          description: ''
      tags: *ref_7
  /graph/objects/{id}/similar:
    get:
      operationId: similar
      summary: Find objects similar to given object id using stored embedding_vec
      description: >-
        Supports same filters as POST /graph/objects/vector-search (type, orgId,
        projectId, branchId, keyPrefix, labelsAll, labelsAny,
        maxDistance|minScore, limit). maxDistance preferred; if both provided,
        maxDistance overrides minScore.
      parameters:
        - name: id
          required: true
          in: path
          schema:
            type: string
        - name: limit
          required: false
          in: query
          description: Limit number of neighbors (1-100); default 10
          schema:
            type: number
        - name: minScore
          required: false
          in: query
          description: >-
            Maximum cosine distance (lower is more similar). 0 ≤ d ≤ 2. Rows
            with distance > threshold filtered out.
          schema:
            type: number
        - name: maxDistance
          required: false
          in: query
          description: >-
            Alias for minScore (preferred name). 0 ≤ d ≤ 2. If both provided,
            maxDistance wins.
          schema:
            type: number
        - name: type
          required: false
          in: query
          description: Filter by object type
          schema:
            type: string
        - name: orgId
          required: false
          in: query
          description: Filter by org id (UUID)
          schema:
            type: string
        - name: projectId
          required: false
          in: query
          description: Filter by project id (UUID)
          schema:
            type: string
        - name: branchId
          required: false
          in: query
          description: Filter by branch id (UUID)
          schema:
            type: string
        - name: keyPrefix
          required: false
          in: query
          description: Filter by key prefix (ILIKE)
          schema:
            type: string
        - name: labelsAll
          required: false
          in: query
          description: Require all labels to be present on object
          schema:
            type: array
            items:
              type: string
        - name: labelsAny
          required: false
          in: query
          description: Require any of the labels to overlap
          schema:
            type: array
            items:
              type: string
      responses:
        '200':
          description: ''
      tags: *ref_7
  /graph/branches/{targetBranchId}/merge:
    post:
      operationId: mergeDryRun
      summary: Branch merge (dry-run or execute)
      description: >-
        Enumerate divergent canonical graph objects between source and target
        branches. Default is dry-run (no mutations). If `execute=true` and there
        are no conflicts: Added objects are cloned into target; Fast-forward
        objects are patched by adding only new properties (superset heuristic).
        Conflicts block apply. Classification statuses: added, unchanged,
        fast_forward, conflict.
      parameters:
        - name: targetBranchId
          required: true
          in: path
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/BranchMergeRequestDto'
      responses:
        '200':
          description: >-
            Merge summary including classification counts, per-object statuses,
            and optional applied/applied_objects when executed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BranchMergeSummaryDto'
        '400':
          description: Missing sourceBranchId or validation error
        '404':
          description: Branch not found
      tags: *ref_7
  /graph/branches:
    post:
      operationId: create
      parameters: []
      responses:
        '201':
          description: ''
    get:
      operationId: list
      parameters:
        - name: project_id
          required: true
          in: query
          schema:
            type: string
      responses:
        '200':
          description: ''
  /product-versions:
    post:
      operationId: create
      parameters: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateProductVersionDto'
      responses:
        '200':
          description: Create product version snapshot
          content:
            application/json:
              schema:
                example:
                  id: 11111111-1111-4111-8111-111111111111
                  name: v1.0.0
                  member_count: 42
        '400':
          description: Name exists
          content:
            application/json:
              schema:
                example:
                  error:
                    code: product_version_name_exists
                    message: Name already exists
      tags: &ref_8
        - Product Versions
    get:
      operationId: list
      parameters:
        - name: cursor
          required: false
          in: query
          description: >-
            Pagination cursor (created_at timestamp of last item from previous
            page)
          schema:
            type: string
        - name: limit
          required: false
          in: query
          description: Number of items per page (1-100, default 20)
          schema:
            type: number
      responses:
        '200':
          description: List product version snapshots for a project
          content:
            application/json:
              schema:
                example:
                  items:
                    - id: ...
                      name: v1.0.0
                      description: null
                      created_at: '2025-01-01T00:00:00Z'
                      member_count: 42
                      base_product_version_id: null
                  next_cursor: '2025-01-01T00:00:00Z'
      tags: *ref_8
  /product-versions/{id}:
    get:
      operationId: get
      parameters:
        - name: id
          required: true
          in: path
          schema:
            type: string
      responses:
        '200':
          description: Get product version snapshot
      tags: *ref_8
  /product-versions/{id}/diff/{otherId}:
    get:
      operationId: diff
      parameters:
        - name: id
          required: true
          in: path
          schema:
            type: string
        - name: otherId
          required: true
          in: path
          schema:
            type: string
      responses:
        '200':
          description: Diff two product version snapshots
          content:
            application/json:
              schema:
                example:
                  items:
                    - canonical_id: ...
                      change_type: modified
                      version_a_object_id: ...
                      version_b_object_id: ...
                  meta:
                    added: 5
                    removed: 2
                    modified: 10
                    unchanged: 100
      tags: *ref_8
  /tags:
    post:
      operationId: create
      parameters: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateTagDto'
      responses:
        '201':
          description: Create tag
          content:
            application/json:
              schema:
                example:
                  id: 11111111-1111-4111-8111-111111111111
                  name: stable
                  product_version_id: 22222222-2222-4222-8222-222222222222
                  description: Stable release
                  created_at: '2025-09-30T00:00:00Z'
        '400':
          description: Tag name exists or product version not found
          content:
            application/json:
              schema:
                example:
                  error:
                    code: tag_name_exists
                    message: Tag name already exists
      tags: &ref_9
        - Tags
    get:
      operationId: list
      parameters:
        - name: cursor
          required: false
          in: query
          description: Pagination cursor (created_at timestamp)
          schema:
            type: string
        - name: limit
          required: false
          in: query
          description: Number of items per page (1-100, default 20)
          schema:
            type: number
      responses:
        '200':
          description: List tags for a project
          content:
            application/json:
              schema:
                example:
                  items:
                    - id: ...
                      name: stable
                      product_version_id: ...
                      description: null
                      created_at: '2025-09-30T00:00:00Z'
                  next_cursor: '2025-09-30T00:00:00Z'
      tags: *ref_9
  /tags/{id}:
    get:
      operationId: get
      parameters:
        - name: id
          required: true
          in: path
          schema:
            type: string
      responses:
        '200':
          description: Get tag by ID
        '404':
          description: Tag not found
      tags: *ref_9
    put:
      operationId: update
      parameters:
        - name: id
          required: true
          in: path
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateTagDto'
      responses:
        '200':
          description: Update tag
        '404':
          description: Tag not found
      tags: *ref_9
    delete:
      operationId: delete
      parameters:
        - name: id
          required: true
          in: path
          schema:
            type: string
      responses:
        '204':
          description: Tag deleted
        '404':
          description: Tag not found
      tags: *ref_9
  /tags/by-name/{name}:
    get:
      operationId: getByName
      parameters:
        - name: name
          required: true
          in: path
          schema:
            type: string
      responses:
        '200':
          description: Get tag by name
        '404':
          description: Tag not found
      tags: *ref_9
  /graph/search:
    post:
      operationId: search
      parameters:
        - name: debug
          required: true
          in: query
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/GraphSearchRequestDto'
      responses:
        '200':
          description: Graph hybrid search results (prototype)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GraphSearchResponseDto'
        '403':
          description: Missing required scope (e.g., debug scope)
          content:
            application/json:
              schema:
                example:
                  error:
                    code: insufficient_scope
                    message: Debug scope required
                    details:
                      missing:
                        - graph:search:debug
      tags:
        - Graph
      security:
        - bearer: []
info:
  title: Spec Server API
  description: >-
    Generated OpenAPI spec (NestJS). NOTE: Each Document MUST belong to a
    Project and each Project belongs to an Organization. Users with no
    accessible Projects must create one before using ingestion or search
    features.
  version: 0.2.0
  contact: {}
tags: []
servers: []
components:
  securitySchemes:
    bearer:
      scheme: bearer
      bearerFormat: JWT
      type: http
  schemas:
    OrgDto:
      type: object
      properties:
        id:
          type: string
          example: org_1
        name:
          type: string
          example: Example Org
      required:
        - id
        - name
    CreateOrgDto:
      type: object
      properties: {}
    ProjectDto:
      type: object
      properties:
        id:
          type: string
          example: proj_1
        name:
          type: string
          example: Demo Project
        orgId:
          type: string
          example: org_1
      required:
        - id
        - name
        - orgId
    CreateProjectDto:
      type: object
      properties:
        name:
          type: string
          example: My Project
          description: Project name (unique per organization, case-insensitive)
        orgId:
          type: string
          description: Organization UUID (must belong to caller; no implicit default org)
      required:
        - name
        - orgId
    SearchResultDto:
      type: object
      properties:
        id:
          type: string
          example: mock-1
        snippet:
          type: string
          example: Result snippet for "foo" (#1, mode=hybrid)
        score:
          type: number
          example: 0.98
        source:
          type: string
          example: source.doc#L10
      required:
        - id
        - snippet
        - score
    SearchResponseDto:
      type: object
      properties:
        mode:
          type: string
          enum:
            - hybrid
            - lexical
            - vector
        results:
          type: array
          items:
            $ref: '#/components/schemas/SearchResultDto'
        warning:
          type: string
          example: Embeddings unavailable; fell back to lexical.
      required:
        - mode
        - results
    DocumentDto:
      type: object
      properties:
        id:
          type: string
          example: doc_1
        orgId:
          type: string
          example: 11111111-2222-3333-4444-555555555555
          nullable: true
        projectId:
          type: string
          example: aaaaaaaa-bbbb-cccc-dddd-eeeeeeeeeeee
          nullable: true
        name:
          type: string
          example: Spec.md
        sourceUrl:
          type: object
          nullable: true
          example: https://example.com/file.pdf
        mimeType:
          type: object
          nullable: true
          example: text/markdown
        createdAt:
          type: string
          example: '2025-01-01T00:00:00.000Z'
        updatedAt:
          type: string
          example: '2025-01-01T00:05:00.000Z'
        chunks:
          type: number
          example: 12
          description: Number of chunks associated with this document
      required:
        - id
        - name
        - createdAt
        - updatedAt
        - chunks
    ChunkDto:
      type: object
      properties:
        id:
          type: string
          example: chunk_1
        documentId:
          type: string
          example: doc_1
        documentTitle:
          type: string
          example: User Guide.pdf
          description: Best-effort document title derived from filename or source URL
        index:
          type: number
          example: 0
          description: Zero-based index of chunk inside the document
        size:
          type: number
          example: 512
          description: Size in characters
        hasEmbedding:
          type: boolean
          example: true
          description: Whether an embedding vector exists for this chunk
        text:
          type: string
          example: This is the chunk text...
          description: Plaintext content of the chunk (may be truncated client-side)
      required:
        - id
        - documentId
        - documentTitle
        - index
        - size
        - hasEmbedding
        - text
    IngestionUploadDto:
      type: object
      properties:
        filename:
          type: string
          description: Original filename (optional, will fallback to uploaded file name)
          example: spec.md
        mimeType:
          type: string
          description: Optional MIME type
          example: text/markdown
        orgId:
          type: string
          description: Optional organisation UUID to associate the document with
          example: 11111111-2222-3333-4444-555555555555
        projectId:
          type: string
          description: Project UUID that this document belongs to (required)
          example: aaaaaaaa-bbbb-cccc-dddd-eeeeeeeeeeee
      required:
        - projectId
    IngestionUrlDto:
      type: object
      properties:
        url:
          type: string
          description: Remote URL to ingest
          example: https://example.com/spec.md
        orgId:
          type: string
          description: Optional organisation UUID to associate the document with
          example: 11111111-2222-3333-4444-555555555555
        projectId:
          type: string
          description: Project UUID that this document belongs to (required)
          example: aaaaaaaa-bbbb-cccc-dddd-eeeeeeeeeeee
      required:
        - url
        - projectId
    ChatRequestDto:
      type: object
      properties: {}
    CitationDto:
      type: object
      properties: {}
    ChatStreamMetaEvent:
      type: object
      properties: {}
    ChatStreamTokenEvent:
      type: object
      properties: {}
    ChatStreamErrorEvent:
      type: object
      properties: {}
    ChatStreamDoneEvent:
      type: object
      properties: {}
    GetChatStreamMetaFrame:
      type: object
      properties: {}
    GetChatStreamTokenFrame:
      type: object
      properties: {}
    GetChatStreamCitationsFrame:
      type: object
      properties: {}
    GetChatStreamSummaryFrame:
      type: object
      properties: {}
    GetChatStreamDoneFrame:
      type: object
      properties: {}
    GetChatStreamErrorFrame:
      type: object
      properties: {}
    CreateInviteDto:
      type: object
      properties: {}
    AcceptInviteDto:
      type: object
      properties: {}
    UserProfileDto:
      type: object
      properties:
        subjectId:
          type: string
          description: Canonical internal user id (subject id, from identity provider)
          format: uuid
        firstName:
          type: object
        lastName:
          type: object
        displayName:
          type: object
          description: Display name fallback (explicit) or derived (first + last)
        phoneE164:
          type: object
          description: E.164 formatted phone number, leading + and digits
        avatarObjectKey:
          type: object
          description: Object storage key for avatar (if stored internally)
      required:
        - subjectId
    UpdateUserProfileDto:
      type: object
      properties: {}
    AlternativeEmailDto:
      type: object
      properties:
        email:
          type: string
          description: Email address (lowercased canonical form)
        verified:
          type: boolean
          description: Verification status
        createdAt:
          type: string
          description: ISO timestamp created
      required:
        - email
        - verified
        - createdAt
    AddAlternativeEmailDto:
      type: object
      properties: {}
    CreateGraphObjectDto:
      type: object
      properties: {}
    PatchGraphObjectDto:
      type: object
      properties: {}
    VersionedObjectDto:
      type: object
      properties:
        id:
          type: string
        org_id:
          type: object
          nullable: true
        project_id:
          type: object
          nullable: true
        canonical_id:
          type: string
        supersedes_id:
          type: object
          nullable: true
        version:
          type: number
        type:
          type: string
        key:
          type: object
          nullable: true
        properties:
          type: object
        labels:
          type: array
          items:
            type: string
        created_at:
          type: string
      required:
        - id
        - org_id
        - project_id
        - canonical_id
        - supersedes_id
        - version
        - type
        - key
        - properties
        - labels
        - created_at
    ObjectHistoryResponseDto:
      type: object
      properties:
        items:
          type: array
          items:
            $ref: '#/components/schemas/VersionedObjectDto'
        next_cursor:
          type: string
          description: Present when more pages available; pass as cursor query param
      required:
        - items
    CreateGraphRelationshipDto:
      type: object
      properties: {}
    PatchGraphRelationshipDto:
      type: object
      properties: {}
    VersionedRelationshipDto:
      type: object
      properties:
        id:
          type: string
        canonical_id:
          type: string
        supersedes_id:
          type: object
          nullable: true
        version:
          type: number
        type:
          type: string
        src_id:
          type: string
        dst_id:
          type: string
        properties:
          type: object
        created_at:
          type: string
        weight:
          type: object
          nullable: true
        valid_from:
          type: object
          nullable: true
        valid_to:
          type: object
          nullable: true
      required:
        - id
        - canonical_id
        - supersedes_id
        - version
        - type
        - src_id
        - dst_id
        - properties
        - created_at
        - weight
        - valid_from
        - valid_to
    RelationshipHistoryResponseDto:
      type: object
      properties:
        items:
          type: array
          items:
            $ref: '#/components/schemas/VersionedRelationshipDto'
        next_cursor:
          type: string
          description: Present when more pages available; pass as cursor query param
      required:
        - items
    TraverseGraphDto:
      type: object
      properties: {}
    GraphExpandDto:
      type: object
      properties: {}
    VectorSearchDto:
      type: object
      properties:
        vector:
          description: Query vector numbers
          type: array
          items:
            type: number
        limit:
          type: number
          description: Max results (default 10, max 100)
          minimum: 1
          maximum: 100
        minScore:
          type: number
          description: >-
            Optional max distance (cosine) filter (0 ≤ d ≤ 2; typical cosine
            range).
          minimum: 0
          maximum: 2
        maxDistance:
          type: number
          description: >-
            Alias for minScore (preferred). Same constraints (0 ≤ d ≤ 2). If
            both provided, maxDistance wins.
          minimum: 0
          maximum: 2
        type:
          type: string
          description: Filter by object type (exact match)
        orgId:
          type: string
          description: Filter by org id
          format: uuid
        projectId:
          type: string
          description: Filter by project id
          format: uuid
        branchId:
          type: string
          description: Filter by branch id
          format: uuid
        keyPrefix:
          type: string
          description: Optional key prefix match (ILIKE prefix%)
        labelsAll:
          description: >-
            Require all labels (array contains) – matches rows whose labels
            array contains every listed label
          type: array
          items:
            type: string
        labelsAny:
          description: >-
            Require any label (overlap) – matches rows whose labels array
            overlaps any listed label
          type: array
          items:
            type: string
      required:
        - vector
    BranchMergeRequestDto:
      type: object
      properties:
        sourceBranchId:
          type: string
          description: Source branch to merge from
        execute:
          type: boolean
          description: >-
            If true, attempt to apply the merge (will fail with 409 if any
            conflicts). When false or omitted, performs a dry-run only.
        limit:
          type: number
          description: >-
            Optional enumeration limit override (must be <= server max).
            Primarily for testing.
      required:
        - sourceBranchId
    BranchMergeObjectSummaryDto:
      type: object
      properties:
        canonical_id:
          type: string
          description: Canonical object id
        status:
          type: string
          enum:
            - unchanged
            - added
            - fast_forward
            - conflict
        source_head_id:
          type: object
          description: Head version id on source branch
          nullable: true
        target_head_id:
          type: object
          description: Head version id on target branch
          nullable: true
        source_paths:
          description: Changed property paths on source since LCA
          type: array
          items:
            type: string
        target_paths:
          description: Changed property paths on target since LCA (empty if no divergence)
          type: array
          items:
            type: string
        conflicts:
          description: >-
            List of conflicting property paths (subset intersection of
            source/target paths with differing final values)
          type: array
          items:
            type: string
      required:
        - canonical_id
        - status
        - source_head_id
        - target_head_id
        - source_paths
        - target_paths
    BranchMergeRelationshipSummaryDto:
      type: object
      properties:
        canonical_id:
          type: string
          description: Canonical relationship id
        status:
          type: string
          enum:
            - unchanged
            - added
            - fast_forward
            - conflict
        source_head_id:
          type: object
          description: Head version id on source branch
          nullable: true
        target_head_id:
          type: object
          description: Head version id on target branch
          nullable: true
        source_src_id:
          type: object
          description: Source node id (src) on source head
          nullable: true
        source_dst_id:
          type: object
          description: Destination node id (dst) on source head
          nullable: true
        target_src_id:
          type: object
          description: Source node id (src) on target head
          nullable: true
        target_dst_id:
          type: object
          description: Destination node id (dst) on target head
          nullable: true
        source_paths:
          description: Changed property paths on source since LCA
          type: array
          items:
            type: string
        target_paths:
          description: Changed property paths on target since LCA (empty if no divergence)
          type: array
          items:
            type: string
        conflicts:
          description: >-
            List of conflicting property paths (subset intersection of
            source/target paths with differing final values)
          type: array
          items:
            type: string
      required:
        - canonical_id
        - status
        - source_head_id
        - target_head_id
        - source_src_id
        - source_dst_id
        - target_src_id
        - target_dst_id
        - source_paths
        - target_paths
    BranchMergeSummaryDto:
      type: object
      properties:
        targetBranchId:
          type: string
          description: Target branch the merge would apply to
        sourceBranchId:
          type: string
          description: Source branch provided in request
        dryRun:
          type: boolean
          description: True if this response is only a dry-run (always true in MVP)
        total_objects:
          type: number
          description: Total divergent canonical objects considered
        unchanged_count:
          type: number
          description: Count of objects unchanged after merge (no action needed)
        added_count:
          type: number
          description: Count of objects newly added by source branch
        fast_forward_count:
          type: number
          description: >-
            Count of objects that can be applied without conflict (fast-forward
            or safe merge)
        conflict_count:
          type: number
          description: Count of objects with conflicts requiring manual resolution
        objects:
          type: array
          items:
            $ref: '#/components/schemas/BranchMergeObjectSummaryDto'
        truncated:
          type: boolean
          description: Set when enumeration truncated due to limit cap
        hard_limit:
          type: number
          description: Server enforced hard limit (for client visibility)
        applied:
          type: boolean
          description: True when merge changes were applied (execute=true & no conflicts)
        applied_objects:
          type: number
          description: >-
            Number of objects mutated/created during apply (added +
            fast_forward)
        relationships_total:
          type: number
          description: Total divergent canonical relationships considered
        relationships_unchanged_count:
          type: number
          description: Count of relationships unchanged after merge (no action needed)
        relationships_added_count:
          type: number
          description: Count of relationships newly added by source branch
        relationships_fast_forward_count:
          type: number
          description: >-
            Count of relationships that can be applied without conflict
            (fast-forward or safe merge)
        relationships_conflict_count:
          type: number
          description: Count of relationships with conflicts requiring manual resolution
        relationships:
          type: array
          items:
            $ref: '#/components/schemas/BranchMergeRelationshipSummaryDto'
      required:
        - targetBranchId
        - sourceBranchId
        - dryRun
        - total_objects
        - unchanged_count
        - added_count
        - fast_forward_count
        - conflict_count
        - objects
    CreateProductVersionDto:
      type: object
      properties: {}
    CreateTagDto:
      type: object
      properties:
        name:
          type: string
          description: Tag name (unique within project)
          example: stable
        product_version_id:
          type: string
          description: Product version ID to tag
          example: 11111111-1111-4111-8111-111111111111
        description:
          type: string
          description: Optional tag description
          example: Stable release for production
      required:
        - name
        - product_version_id
    UpdateTagDto:
      type: object
      properties:
        description:
          type: string
          description: Updated tag description
          example: Updated stable release
    GraphSearchFiltersDto:
      type: object
      properties:
        objectTypes:
          type: array
          items:
            type: string
        excludeObjectTypes:
          type: array
          items:
            type: string
        labelsAny:
          type: array
          items:
            type: string
        updatedAfter:
          type: string
          example: '2025-09-01T00:00:00Z'
        updatedBefore:
          type: string
          example: '2025-09-20T00:00:00Z'
    GraphSearchNeighborDto:
      type: object
      properties:
        perPrimaryLimit:
          type: number
          minimum: 0
          default: 3
        globalLimit:
          type: number
          minimum: 0
          default: 50
        maxDepth:
          type: number
          minimum: 0
          default: 1
        edgeTypes:
          example:
            - decides
            - attended_by
          type: array
          items:
            type: string
    GraphSearchDocumentFusionDto:
      type: object
      properties:
        enabled:
          type: boolean
          default: false
        topK:
          type: number
          default: 8
          minimum: 1
          maximum: 50
        mode:
          type: string
          enum:
            - blend
            - rrf
            - sequential
          default: blend
        weight:
          type: number
          default: 0.35
          minimum: 0
          maximum: 1
    GraphSearchPaginationDto:
      type: object
      properties:
        cursor:
          type: object
          example: null
        limit:
          type: number
          minimum: 1
          maximum: 100
          default: 40
        direction:
          type: string
          enum:
            - forward
            - backward
          default: forward
          description: >-
            Pagination direction relative to cursor (forward = items after
            cursor, backward = items before cursor). Only meaningful when cursor
            is supplied.
    GraphSearchRequestDto:
      type: object
      properties:
        query:
          type: string
          description: Search query
          maxLength: 800
        limit:
          type: number
          minimum: 1
          maximum: 100
          default: 40
        intentOverride:
          type: string
          enum:
            - explain
            - locate_config
            - debug_error
            - roadmap
          example: explain
        channels:
          type: array
          items:
            type: string
            enum:
              - lexical
              - vector
              - neighbor_boost
              - doc
        rerank:
          type: object
          default: null
        maxTokenBudget:
          type: number
          minimum: 800
          maximum: 6000
          default: 3500
        includeCitations:
          type: boolean
          default: false
        includePathSummaries:
          type: boolean
          default: true
        includeDebug:
          type: boolean
          default: false
        filters:
          $ref: '#/components/schemas/GraphSearchFiltersDto'
        neighbor:
          $ref: '#/components/schemas/GraphSearchNeighborDto'
        documentFusion:
          $ref: '#/components/schemas/GraphSearchDocumentFusionDto'
        pagination:
          $ref: '#/components/schemas/GraphSearchPaginationDto'
        experimental:
          type: object
          description: Experimental feature flags container
      required:
        - query
    GraphSearchReasonDto:
      type: object
      properties:
        channel:
          type: string
          enum:
            - lexical
            - vector
            - neighbor_boost
            - doc
        score:
          type: number
          example: 0.42
      required:
        - channel
        - score
    GraphSearchCitationDto:
      type: object
      properties:
        span:
          type: string
          example: Decision depends on consistent flag rollout
        source_object_id:
          type: string
          example: b3d52c50-5101-4c6c-8d30-4a1f0f7645cb
        confidence:
          type: number
          example: 0.82
      required:
        - span
        - source_object_id
        - confidence
    GraphSearchItemDto:
      type: object
      properties:
        object_id:
          type: string
          example: af6b1db2-e7f9-4d2f-b3f4-5d8c0c61c9cd
        canonical_id:
          type: string
          example: af6b1db2-e7f9-4d2f-b3f4-5d8c0c61c9cd
        score:
          type: number
          example: 0.87123
        rank:
          type: number
          example: 1
        role:
          type: string
          enum:
            - primary
            - neighbor
            - reference
            - document_chunk
        fields:
          type: object
          example:
            title: Adopt Feature Flagging
            type: Decision
            status: active
        truncated_fields:
          example:
            - description
          type: array
          items:
            type: string
        reasons:
          type: array
          items:
            $ref: '#/components/schemas/GraphSearchReasonDto'
        citations:
          type: array
          items:
            $ref: '#/components/schemas/GraphSearchCitationDto'
        explanation:
          type: string
          example: High lexical match on ...
        cursor:
          type: string
          example: eyJzY29yZSI6MC44NzEyMywiaWQiOiJkb2MtMSJ9
      required:
        - object_id
        - canonical_id
        - score
        - rank
        - role
        - fields
        - reasons
    GraphSearchPathSummaryDto:
      type: object
      properties:
        path_id:
          type: string
          example: e7b7ff6e-ef5f-4b55-9580-5d3b45d0a123
        summary:
          type: string
          example: Meeting X decided Decision Y
        reasons:
          type: array
          items:
            $ref: '#/components/schemas/GraphSearchReasonDto'
      required:
        - path_id
        - summary
        - reasons
    GraphSearchEmbeddingModelMetaDto:
      type: object
      properties:
        model:
          type: string
          example: text-embedding-3-large
        version:
          type: number
          example: 2
        coverage_pct:
          type: number
          example: 91.4
      required:
        - model
        - version
        - coverage_pct
    GraphSearchRerankMetaDto:
      type: object
      properties:
        applied:
          type: boolean
          example: true
        model:
          type: string
          example: mini-cross-encoder-v1
        latency_ms:
          type: number
          example: 42
        pool:
          type: number
          example: 60
        timeout:
          type: boolean
          example: false
      required:
        - applied
    GraphSearchExpansionMetaDto:
      type: object
      properties:
        neighbors:
          type: number
          example: 42
        hub_sampled:
          type: boolean
          example: true
        hub_degree:
          type: number
          example: 1342
      required:
        - neighbors
        - hub_sampled
    GraphSearchRequestMetaDto:
      type: object
      properties:
        limit:
          type: number
          example: 40
          description: Effective page size after server cap
        requested_limit:
          type: number
          example: 100
          description: Original client requested limit before clamping
        channels:
          example:
            - lexical
            - vector
          type: array
          items:
            type: string
        rerank:
          type: object
          example: false
        direction:
          type: string
          example: forward
          enum:
            - forward
            - backward
          description: Pagination direction used for this page.
      required:
        - limit
    GraphSearchMetaDto:
      type: object
      properties:
        channels:
          example:
            - lexical
            - vector
          type: array
          items:
            type: string
        fusion:
          type: string
          example: weighted_sum:v2
        normalization_version:
          type: string
          example: zscore_v1
        lexical_considered:
          type: number
          example: 100
        vector_considered:
          type: number
          example: 100
        skipped_unembedded:
          type: number
          example: 12
        neighbor_expanded:
          type: number
          example: 47
        token_estimate:
          type: number
          example: 1450
        token_budget:
          type: number
          example: 3500
        truncation_notice:
          type: boolean
          example: false
        warnings:
          example:
            - embedding_version_backlog
          type: array
          items:
            type: string
        embedding_model:
          $ref: '#/components/schemas/GraphSearchEmbeddingModelMetaDto'
        rerank:
          $ref: '#/components/schemas/GraphSearchRerankMetaDto'
        expansion:
          $ref: '#/components/schemas/GraphSearchExpansionMetaDto'
        request:
          $ref: '#/components/schemas/GraphSearchRequestMetaDto'
        elapsed_ms:
          type: number
          example: 92
        total_estimate:
          type: number
          example: 8
          description: >-
            Total size of fused candidate pool prior to pagination (may be less
            than lexical_considered+vector_considered due to overlaps).
        nextCursor:
          type: object
          example: null
        prevCursor:
          type: object
          example: null
        hasNext:
          type: boolean
          example: true
        hasPrev:
          type: boolean
          example: false
        approx_position_start:
          type: number
          example: 41
          description: >-
            Approximate 1-based index of first item in this page relative to
            fused pool snapshot. 0 if page empty.
        approx_position_end:
          type: number
          example: 80
          description: >-
            Approximate 1-based index of last item in this page relative to
            fused pool snapshot. 0 if page empty.
      required:
        - channels
        - fusion
        - normalization_version
        - lexical_considered
        - vector_considered
        - skipped_unembedded
        - neighbor_expanded
        - token_estimate
        - token_budget
        - truncation_notice
        - embedding_model
        - rerank
        - expansion
        - request
        - elapsed_ms
        - total_estimate
        - hasNext
        - hasPrev
    GraphSearchDebugDto:
      type: object
      properties:
        normalization:
          type: object
          example:
            lexical:
              mean: 0.42
              std: 0.11
        gain_rejections:
          type: number
          example: 5
        marginal_gain_min:
          type: number
          example: 0.02
        edge_samples:
          example:
            - relation: decides
              edge_score: 0.63
              depth: 1
              hub_damping: 0.43
          type: array
          items:
            type: object
        feature_flags:
          type: object
          example:
            paths: true
            rerank: true
            citations: false
      required:
        - normalization
        - gain_rejections
        - marginal_gain_min
        - edge_samples
        - feature_flags
    GraphSearchResponseDto:
      type: object
      properties:
        query:
          type: string
          example: original query text
        intent:
          type: string
          enum:
            - explain
            - locate_config
            - debug_error
            - roadmap
        items:
          type: array
          items:
            $ref: '#/components/schemas/GraphSearchItemDto'
        path_summaries:
          type: array
          items:
            $ref: '#/components/schemas/GraphSearchPathSummaryDto'
        meta:
          $ref: '#/components/schemas/GraphSearchMetaDto'
        debug:
          $ref: '#/components/schemas/GraphSearchDebugDto'
      required:
        - query
        - items
        - meta
x-tagGroups:
  - name: Health & Auth
    tags:
      - Health
      - Auth
  - name: Organizations & Projects
    tags:
      - Orgs
      - Projects
  - name: Configuration
    tags:
      - Settings
  - name: Content & Ingestion
    tags:
      - Ingestion
      - Documents
      - Chunks
  - name: Search
    tags:
      - Search
  - name: Chat
    tags:
      - Chat
