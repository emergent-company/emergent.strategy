# =============================================================================
# SERVER .ENV - SERVER APPLICATION CONFIGURATION
# =============================================================================
#
# This file contains SAFE DEFAULTS for the NestJS server application.
# It is COMMITTED to the repository and should NOT contain secrets.
#
# ORGANIZATION:
# - apps/server/.env       → Server defaults (THIS FILE)
# - apps/server/.env.local → User overrides & secrets (GITIGNORED)
# - Root .env              → Workspace/shared variables
#
# LOADING PRECEDENCE:
# apps/server/.env.local > apps/server/.env > root .env.local > root .env
#
# SECRETS POLICY:
# - Keep real API keys/credentials in apps/server/.env.local
# - This file contains only safe defaults and placeholders
# =============================================================================

# -----------------------------------------------------------------------------
# Environment Configuration
# -----------------------------------------------------------------------------
# Environment type - determines which Infisical environment to use (REQUIRED)
# Options: local | dev | staging | production
# Inherited from root .env, but can be overridden here
# ENVIRONMENT=local

# -----------------------------------------------------------------------------
# Core Server Configuration
# -----------------------------------------------------------------------------
# Server HTTP port (REQUIRED)
PORT=3002

# Node environment (REQUIRED)
NODE_ENV=development

# CORS allowed origins (OPTIONAL)
CORS_ORIGIN=http://localhost:5176

# -----------------------------------------------------------------------------
# Database Configuration (PostgreSQL)
# -----------------------------------------------------------------------------
# Database host (REQUIRED)
POSTGRES_HOST=localhost

# Database port (REQUIRED)
POSTGRES_PORT=5432

# Database user (REQUIRED)
POSTGRES_USER=spec

# Database password (REQUIRED) (SECRET)
POSTGRES_PASSWORD=spec

# Database name (REQUIRED)
POSTGRES_DB=spec

# Enable automatic database initialization (OPTIONAL)
DB_AUTOINIT=true
# SKIP_DB=1  # Uncomment to skip DB init (for builds/tests)
# SKIP_MIGRATIONS=1  # Uncomment to skip migrations

# E2E testing database name (OPTIONAL)
POSTGRES_DB_E2E=spec_e2e

# Row-Level Security bypass password (OPTIONAL) (SECRET)
APP_RLS_PASSWORD=

# Enable strict RLS policy enforcement (OPTIONAL)
RLS_POLICY_STRICT=false

# -----------------------------------------------------------------------------
# Authentication & Authorization (Zitadel)
# -----------------------------------------------------------------------------
# OIDC issuer URL (OPTIONAL)
ZITADEL_ISSUER=http://localhost:8080

# Service Account JWT content (OPTIONAL) (SECRET)
ZITADEL_CLIENT_JWT=

# Service Account JWT file path (OPTIONAL)
ZITADEL_CLIENT_JWT_PATH=

# API Service Account JWT content (OPTIONAL) (SECRET)
ZITADEL_API_JWT=

# API Service Account JWT file path (OPTIONAL)
ZITADEL_API_JWT_PATH=

# Main organization ID (OPTIONAL)
ZITADEL_MAIN_ORG_ID=

# Bypass scope enforcement - development only (OPTIONAL)
SCOPES_DISABLED=0  # Set to 1 to bypass scope enforcement (dev only)

# Debug auth scopes (OPTIONAL)
# DEBUG_AUTH_SCOPES=1  # Uncomment to debug auth scopes

# Debug auth claims (OPTIONAL)
# DEBUG_AUTH_CLAIMS=1  # Uncomment to debug auth claims

# Debug tenant resolution (OPTIONAL)
# DEBUG_TENANT=1  # Uncomment to debug tenant resolution

# -----------------------------------------------------------------------------
# Google Cloud Platform (GCP)
# -----------------------------------------------------------------------------
# GCP project ID (REQUIRED)
GCP_PROJECT_ID=spec-server

# Google API key for Gemini (OPTIONAL) (SECRET)
GOOGLE_API_KEY=

# Path to GCP credentials JSON (OPTIONAL)
GOOGLE_APPLICATION_CREDENTIALS=

# Google OAuth redirect URL for integration scripts (OPTIONAL)
GOOGLE_REDIRECT_URL=http://localhost:3003/oauth/callback

# -----------------------------------------------------------------------------
# Google OAuth (Gmail/Drive Data Sources)
# -----------------------------------------------------------------------------
# OAuth 2.0 Client ID from GCP Console (OPTIONAL) (SECRET)
# Create at: https://console.cloud.google.com/apis/credentials
GOOGLE_OAUTH_CLIENT_ID=

# OAuth 2.0 Client Secret from GCP Console (OPTIONAL) (SECRET)
GOOGLE_OAUTH_CLIENT_SECRET=

# Base URL for this API server (for OAuth callbacks) (OPTIONAL)
# Used to construct redirect_uri: {API_BASE_URL}/data-source-integrations/oauth/google/callback
API_BASE_URL=http://localhost:3002

# Base URL for the admin frontend (for OAuth completion redirects) (OPTIONAL)
ADMIN_BASE_URL=http://localhost:5176

# -----------------------------------------------------------------------------
# AI & LLM Configuration (Vertex AI / Gemini)
# -----------------------------------------------------------------------------
# Vertex AI region (REQUIRED)
VERTEX_AI_LOCATION=us-central1

# Vertex AI model name (REQUIRED)
# Available models:
#   - gemini-2.5-flash-lite (recommended for extraction - fast and efficient)
#   - gemini-1.5-flash (stable, well-tested)
#   - gemini-1.5-pro (most capable, slower, more expensive)
#   - gemini-1.0-pro (legacy)
#   - gemini-2.0-flash-exp (experimental preview)
VERTEX_AI_MODEL=gemini-2.5-flash-lite

# Embeddings provider (OPTIONAL)
EMBEDDING_PROVIDER=vertex

# Embeddings dimension (OPTIONAL)
EMBEDDING_DIMENSION=768

# Disable embeddings network calls (OPTIONAL)
EMBEDDINGS_NETWORK_DISABLED=false

# Enable chat model (OPTIONAL)
CHAT_MODEL_ENABLED=true

# Custom chat system prompt (OPTIONAL)
CHAT_SYSTEM_PROMPT=

# Enable automatic title generation for new conversations (OPTIONAL)
CHAT_TITLE_GENERATION_ENABLED=true

# Maximum length for generated conversation titles (OPTIONAL)
CHAT_TITLE_MAX_LENGTH=60

# Minimum messages before generating title (OPTIONAL)
CHAT_TITLE_MIN_MESSAGES=2

# -----------------------------------------------------------------------------
# Extraction Worker Configuration
# -----------------------------------------------------------------------------
# Enable extraction worker (OPTIONAL)
EXTRACTION_WORKER_ENABLED=false

# Worker poll interval in milliseconds (OPTIONAL)
EXTRACTION_WORKER_POLL_INTERVAL_MS=5000

# Worker batch size (OPTIONAL)
EXTRACTION_WORKER_BATCH_SIZE=5

# Rate limit requests per minute (OPTIONAL)
EXTRACTION_RATE_LIMIT_RPM=60

# Rate limit tokens per minute (OPTIONAL)
EXTRACTION_RATE_LIMIT_TPM=30000

# Entity linking strategy (OPTIONAL)
# Options: always_new | key_match | vector_similarity | user_review
EXTRACTION_ENTITY_LINKING_STRATEGY=always_new

# Minimum confidence threshold 0.0-1.0 (OPTIONAL)
EXTRACTION_CONFIDENCE_THRESHOLD_MIN=0.0

# Review confidence threshold 0.0-1.0 (OPTIONAL)
EXTRACTION_CONFIDENCE_THRESHOLD_REVIEW=0.7

# Auto-accept confidence threshold 0.0-1.0 (OPTIONAL)
EXTRACTION_CONFIDENCE_THRESHOLD_AUTO=0.85

# Default template pack UUID (OPTIONAL)
EXTRACTION_DEFAULT_TEMPLATE_PACK_ID=

# Chunk size for text splitting (OPTIONAL)
EXTRACTION_CHUNK_SIZE=100000

# Chunk overlap for text splitting (OPTIONAL)
EXTRACTION_CHUNK_OVERLAP=2000

# Base prompt override (OPTIONAL)
EXTRACTION_BASE_PROMPT=

# -----------------------------------------------------------------------------
# Observability (LangSmith)
# -----------------------------------------------------------------------------
# Enable LangSmith tracing (OPTIONAL)
LANGSMITH_TRACING=false

# LangSmith API endpoint (OPTIONAL)
LANGSMITH_ENDPOINT=

# LangSmith API key (OPTIONAL) (SECRET)
LANGSMITH_API_KEY=

# LangSmith project name (OPTIONAL)
LANGSMITH_PROJECT=

# LangChain legacy settings (OPTIONAL)
# LANGCHAIN_TRACING_V2=  # Set to "true" to enable
# LANGCHAIN_ENDPOINT=
# LANGCHAIN_API_KEY=
# LANGCHAIN_PROJECT=

# -----------------------------------------------------------------------------
# Observability (Langfuse)
# -----------------------------------------------------------------------------
# Enable Langfuse tracing and prompt management (OPTIONAL)
LANGFUSE_ENABLED=false

# Langfuse host URL (OPTIONAL)
LANGFUSE_HOST=http://localhost:3011

# Langfuse public key (OPTIONAL) (SECRET)
LANGFUSE_PUBLIC_KEY=

# Langfuse secret key (OPTIONAL) (SECRET)
LANGFUSE_SECRET_KEY=

# Langfuse flush settings (OPTIONAL)
LANGFUSE_FLUSH_AT=10
LANGFUSE_FLUSH_INTERVAL=5000

# Langfuse prompt management (OPTIONAL)
# Cache TTL in seconds for fetched prompts
LANGFUSE_PROMPT_CACHE_TTL=60

# Default label for prompt fetching (e.g., "production", "development")
LANGFUSE_PROMPT_LABEL=production

# -----------------------------------------------------------------------------
# Observability (OpenTelemetry / SigNoz)
# -----------------------------------------------------------------------------
# Enable OpenTelemetry distributed tracing (OPTIONAL)
OTEL_ENABLED=false

# Service name for tracing (OPTIONAL)
OTEL_SERVICE_NAME=emergent-server

# OTLP exporter endpoint (OPTIONAL)
# For local SigNoz: http://localhost:4317 (gRPC)
# For remote SigNoz: http://signoz.example.com:4317
OTEL_EXPORTER_OTLP_ENDPOINT=http://localhost:4317

# OpenTelemetry log level (OPTIONAL)
# Options: debug | info | warn | error
OTEL_LOG_LEVEL=info

# -----------------------------------------------------------------------------
# Seeding & Testing
# -----------------------------------------------------------------------------
# Seed demo organizations (OPTIONAL)
ORGS_DEMO_SEED=false

# Bible test dataset API URL (OPTIONAL)
BIBLE_SEED_API_URL=http://localhost:3000

# Bible test dataset access token (OPTIONAL) (SECRET)
BIBLE_SEED_ACCESS_TOKEN=

# Bible test dataset rate limit (OPTIONAL)
BIBLE_SEED_RATE_LIMIT_MS=100

# -----------------------------------------------------------------------------
# Logging & Debugging
# -----------------------------------------------------------------------------
# LOG_DIR=  # Custom log directory
# HTTP_LOG_PATH=  # Path for HTTP access logs
# ERROR_LOG_INCLUDE_STACK=1  # Include stack traces in errors

# Audit Logging
# AUDIT_INTERCEPTOR_ENABLED=1
# AUDIT_CONSOLE_LOGGING=1
# AUDIT_DATABASE_LOGGING=1

# Cache
# CACHE_CLEANUP_INTERVAL=  # Interval for cache cleanup

# -----------------------------------------------------------------------------
# Email Configuration (Mailgun)
# -----------------------------------------------------------------------------
# Enable email sending (OPTIONAL)
EMAIL_ENABLED=false

# Email worker poll interval in milliseconds (OPTIONAL)
EMAIL_WORKER_INTERVAL_MS=10000

# Email worker batch size (OPTIONAL)
EMAIL_WORKER_BATCH_SIZE=5

# Maximum retry attempts for failed emails (OPTIONAL)
EMAIL_MAX_RETRIES=3

# Retry delay in seconds (OPTIONAL)
EMAIL_RETRY_DELAY_SEC=60

# Mailgun API key (OPTIONAL) (SECRET)
MAILGUN_API_KEY=

# Mailgun domain (e.g., mg.yourdomain.com) (OPTIONAL)
MAILGUN_DOMAIN=

# Mailgun API URL (OPTIONAL)
# Use https://api.eu.mailgun.net for EU region
MAILGUN_API_URL=https://api.mailgun.net

# Default sender email address (OPTIONAL)
MAILGUN_FROM_EMAIL=noreply@yourdomain.com

# Default sender name (OPTIONAL)
MAILGUN_FROM_NAME=Emergent

# -----------------------------------------------------------------------------
# NOTES
# -----------------------------------------------------------------------------
#
# WORKSPACE VARIABLES: See root .env.example
# - NAMESPACE, ports, test users
#
# ADMIN VARIABLES: See apps/admin/.env.example
# - Frontend configuration (VITE_*)
#
# USER SECRETS: Create apps/server/.env.local for real credentials
# Example apps/server/.env.local:
#   GOOGLE_API_KEY=AIza...
#   POSTGRES_PASSWORD=my-secure-password
#   ZITADEL_CLIENT_JWT=eyJhbGc...
#   LANGSMITH_API_KEY=lsv2_pt_...
#
