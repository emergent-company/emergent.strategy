# Coolify Docker Compose Deployment Fix

## Problem

Coolify builds were failing with error:
```
failed to compute cache key: failed to calculate checksum of ref: "/apps/admin": not found
failed to compute cache key: failed to calculate checksum of ref: "/apps/server-nest": not found
```

This error occurs **before** any Dockerfile commands execute, during BuildKit's cache key calculation phase.

## Root Cause

The issue is likely that Coolify is not correctly setting the build context to the repository root (`.`), causing Docker to not see the `apps/` directory.

## Solution: Use Docker Compose

Instead of building individual Dockerfiles, use the `docker-compose.coolify.yml` file which **explicitly** sets the build context and Dockerfile paths.

### Setup in Coolify

1. **Change deployment type to Docker Compose:**
   - In your Coolify project settings
   - Change from "Dockerfile" to "Docker Compose"
   
2. **Set the Docker Compose file path:**
   - Docker Compose File: `docker-compose.coolify.yml`
   
3. **Configure environment variables** (copy from `.env.staging`):
   - All variables should be set in Coolify's environment section
   - Make sure `VITE_*` variables are set as "Build & Runtime"
   - All other variables as "Runtime Only"

### Why This Works

The `docker-compose.coolify.yml` explicitly defines:

```yaml
services:
  server:
    build:
      context: .                              # ← EXPLICIT: Repository root
      dockerfile: apps/server-nest/Dockerfile # ← EXPLICIT: Path to Dockerfile
      
  admin:
    build:
      context: .                              # ← EXPLICIT: Repository root  
      dockerfile: apps/admin/Dockerfile       # ← EXPLICIT: Path to Dockerfile
```

This removes any ambiguity about where Docker should look for files.

### Alternative: Check Coolify Settings

If you want to keep using individual Dockerfiles, check these Coolify settings:

1. **Build Context:**
   - Should be: `.` (dot - repository root)
   - NOT: `/` or `./apps/admin` or `./apps/server-nest`

2. **Dockerfile Path:**
   - Admin: `apps/admin/Dockerfile`
   - Server: `apps/server-nest/Dockerfile`

3. **Git Branch:**
   - Make sure you're deploying from `master` branch
   - Verify latest commits are pulled (check commit hash in logs)

## Debug Output

We added extensive debug logging to the Dockerfile, but the error occurs **before** these run. If you see debug output in the logs, that's a good sign - it means the build context is working and we're past the initial error.

## Next Steps

1. Push this Docker Compose file to your repository (done)
2. Change Coolify to use Docker Compose deployment
3. Try building again
4. If it works, remove the debug RUN commands from the Dockerfile

## Files

- `docker-compose.coolify.yml` - Main deployment configuration
- `.env.staging` - Environment variables (generated by `scripts/setup-coolify.sh`)
