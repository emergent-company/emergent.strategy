# Zitadel Environment Variables - Quick Reference

## Dual Service Account Configuration (Recommended)

### Required Variables

```env
# Zitadel Instance
ZITADEL_DOMAIN=your-instance.zitadel.cloud

# Organization and Project IDs
ZITADEL_ORG_ID=123456789012345678
ZITADEL_PROJECT_ID=123456789012345678

# CLIENT Service Account (for introspection)
# Choose ONE:
ZITADEL_CLIENT_JWT='{"type":"serviceaccount","keyId":"...","key":"-----BEGIN RSA PRIVATE KEY-----\n...","userId":"...","clientId":"..."}'
# OR
ZITADEL_CLIENT_JWT_PATH=/app/secrets/zitadel-client-service-account.json

# API Service Account (for Management API)
# Choose ONE:
ZITADEL_API_JWT='{"type":"serviceaccount","keyId":"...","key":"-----BEGIN RSA PRIVATE KEY-----\n...","userId":"...","clientId":"..."}'
# OR
ZITADEL_API_JWT_PATH=/app/secrets/zitadel-api-service-account.json
```

## Legacy Single Account Configuration (Deprecated)

### For Backward Compatibility

If dual service account variables are not set, the system falls back to legacy mode:

```env
ZITADEL_ISSUER=https://your-instance.zitadel.cloud
ZITADEL_INTROSPECTION_URL=https://your-instance.zitadel.cloud/oauth/v2/introspect
ZITADEL_CLIENT_ID=123456789012345678@project-name
ZITADEL_CLIENT_SECRET=your-client-secret
ZITADEL_MAIN_ORG_ID=123456789012345678
```

⚠️ **Warning:** Legacy mode uses the same credentials for both introspection and Management API, which is less secure.

## Environment Variable Priority

The system checks variables in this order:

1. **Dual Service Account** (if CLIENT vars present):
   - `ZITADEL_CLIENT_JWT` or `ZITADEL_CLIENT_JWT_PATH` for introspection
   - `ZITADEL_API_JWT` or `ZITADEL_API_JWT_PATH` for Management API
   - Falls back to CLIENT for API if API vars not set

2. **Legacy Single Account** (if dual vars not present):
   - Uses `ZITADEL_CLIENT_ID` + `ZITADEL_CLIENT_SECRET` for both operations

## Variable Details

### ZITADEL_DOMAIN
- **Required:** Yes
- **Format:** `instance.zitadel.cloud` (no protocol)
- **Used by:** All Zitadel operations
- **Example:** `my-app.zitadel.cloud`

### ZITADEL_ORG_ID
- **Required:** Yes (for dual account mode)
- **Format:** Numeric string
- **Used by:** Management API operations
- **Get from:** Zitadel Console → Organization Settings

### ZITADEL_PROJECT_ID
- **Required:** Yes (for dual account mode)
- **Format:** Numeric string
- **Used by:** Token introspection and Management API
- **Get from:** Zitadel Console → Projects → Your Project

### ZITADEL_CLIENT_JWT
- **Required:** One of CLIENT_JWT or CLIENT_JWT_PATH
- **Format:** JSON string (escaped for Coolify)
- **Contains:** Service account key for introspection
- **Generated by:** `scripts/setup-zitadel-service-accounts.sh`
- **Security:** Handle Coolify double-escaping automatically

### ZITADEL_CLIENT_JWT_PATH
- **Required:** One of CLIENT_JWT or CLIENT_JWT_PATH
- **Format:** Absolute file path
- **Points to:** `zitadel-client-service-account.json`
- **Example:** `/app/secrets/zitadel-client-service-account.json`
- **Recommended for:** Production (more secure than inline JSON)

### ZITADEL_API_JWT
- **Required:** One of API_JWT or API_JWT_PATH (optional, falls back to CLIENT)
- **Format:** JSON string (escaped for Coolify)
- **Contains:** Service account key for Management API
- **Generated by:** `scripts/setup-zitadel-service-accounts.sh`

### ZITADEL_API_JWT_PATH
- **Required:** One of API_JWT or API_JWT_PATH (optional, falls back to CLIENT)
- **Format:** Absolute file path
- **Points to:** `zitadel-api-service-account.json`
- **Example:** `/app/secrets/zitadel-api-service-account.json`
- **Recommended for:** Production (more secure than inline JSON)

## Coolify Deployment

### Using File Paths (Recommended)

1. **Upload JSON files** to server:
   ```bash
   scp secrets/*.json user@server:/app/secrets/
   ```

2. **Set environment variables** in Coolify:
   ```env
   ZITADEL_DOMAIN=your-instance.zitadel.cloud
   ZITADEL_ORG_ID=123456789012345678
   ZITADEL_PROJECT_ID=123456789012345678
   ZITADEL_CLIENT_JWT_PATH=/app/secrets/zitadel-client-service-account.json
   ZITADEL_API_JWT_PATH=/app/secrets/zitadel-api-service-account.json
   ```

3. **Ensure volumes mounted** in docker-compose.yml:
   ```yaml
   services:
     server:
       volumes:
         - ./secrets:/app/secrets:ro
   ```

### Using Inline JSON (Alternative)

1. **Copy JSON content** from files
2. **Set as environment variables** in Coolify (it will double-escape automatically)
3. **Code handles Coolify escaping** - no manual escaping needed

## Verification

After setting environment variables, check server logs on startup:

```
✅ CLIENT service account loaded (keyId: 123456789012345678)
✅ API service account loaded (keyId: 234567890123456789)
✅ Dual service account mode active
```

Or if API not set:

```
⚠️ API service account not configured, using CLIENT account for Management API (not recommended)
```

## Troubleshooting

### "CLIENT service account key not configured"
- Check `ZITADEL_CLIENT_JWT` or `ZITADEL_CLIENT_JWT_PATH` is set
- Verify file path is accessible from container
- Check file permissions (readable by server process)

### "Failed to parse CLIENT Zitadel key"
- Verify JSON syntax: `jq . secrets/zitadel-client-service-account.json`
- If using inline JSON on Coolify, escaping is automatic
- Check logs for "trying to unescape" message

### "Invalid CLIENT key format: missing keyId or key"
- Regenerate keys: `./scripts/setup-zitadel-service-accounts.sh secrets/`
- Verify JSON structure matches expected format

## Migration Checklist

- [ ] Run provisioning script to generate dual service accounts
- [ ] Update environment variables (add CLIENT/API vars)
- [ ] Upload JSON files to production server (if using file paths)
- [ ] Restart server
- [ ] Verify logs show "Dual service account mode active"
- [ ] Test introspection endpoint (no 500 errors)
- [ ] Test user creation/management
- [ ] Monitor for 24-48 hours
- [ ] (Optional) Remove legacy variables after verification

## Next Steps

See `docs/ZITADEL_DUAL_SERVICE_ACCOUNT_SETUP.md` for complete setup instructions.
