{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://emergent.build/schemas/outputs/development-brief.schema.json",
  "title": "Development Handover Brief Schema",
  "description": "Validates input parameters for generating development handover briefs from EPF artifacts. The brief enables product management to communicate implementation scope and context to engineering teams.",
  "version": "1.0.0",
  "type": "object",

  "definitions": {
    "github_repo_config": {
      "type": "object",
      "description": "GitHub repository configuration for generating permalinks to EPF artifacts",
      "required": ["owner", "repo", "branch"],
      "properties": {
        "owner": {
          "type": "string",
          "description": "GitHub repository owner/organization (e.g., eyedea-io)",
          "pattern": "^[a-zA-Z0-9]([a-zA-Z0-9-]*[a-zA-Z0-9])?$"
        },
        "repo": {
          "type": "string",
          "description": "GitHub repository name (e.g., lawmatics)",
          "pattern": "^[a-zA-Z0-9._-]+$"
        },
        "branch": {
          "type": "string",
          "description": "Branch name for permalinks (e.g., dev, main). Use default branch for stable links.",
          "default": "main"
        },
        "commit_sha": {
          "type": "string",
          "description": "Optional: specific commit SHA for immutable permalinks (40 hex chars)",
          "pattern": "^[a-f0-9]{40}$"
        }
      },
      "additionalProperties": false
    },

    "metadata": {
      "type": "object",
      "description": "Generation metadata tracking source and freshness",
      "required": ["generated_at", "generator", "epf_version", "epf_sources", "github_repo"],
      "properties": {
        "generated_at": {
          "type": "string",
          "format": "date-time",
          "description": "ISO 8601 timestamp of generation"
        },
        "generator": {
          "type": "string",
          "description": "Name of the wizard that generated this output",
          "const": "development-brief/wizard.instructions.md"
        },
        "generator_version": {
          "type": "string",
          "pattern": "^\\d+\\.\\d+\\.\\d+$",
          "description": "Semantic version of the generator"
        },
        "epf_version": {
          "type": "string",
          "pattern": "^\\d+\\.\\d+\\.\\d+$",
          "description": "EPF framework version used"
        },
        "epf_sources": {
          "type": "object",
          "description": "EPF source files used for generation - all paths are GitHub permalink URLs",
          "properties": {
            "north_star": { 
              "type": "string",
              "format": "uri",
              "description": "GitHub permalink to north star document"
            },
            "strategy_formula": { 
              "type": "string",
              "format": "uri",
              "description": "GitHub permalink to strategy formula"
            },
            "roadmap_recipe": { 
              "type": "string",
              "format": "uri",
              "description": "GitHub permalink to roadmap recipe"
            },
            "value_models": {
              "type": "array",
              "items": { 
                "type": "string",
                "format": "uri",
                "description": "GitHub permalink to value model"
              }
            },
            "feature_definitions": {
              "type": "array",
              "items": { 
                "type": "string",
                "format": "uri",
                "description": "GitHub permalink to feature definition"
              }
            }
          }
        },
        "github_repo": {
          "$ref": "#/definitions/github_repo_config"
        }
      }
    },

    "feature_selection": {
      "type": "object",
      "description": "A selected feature definition for the brief",
      "required": ["feature_id", "feature_name", "feature_path"],
      "properties": {
        "feature_id": {
          "type": "string",
          "description": "EPF feature definition ID (e.g., fd-017)",
          "pattern": "^fd-\\d{3}(-[a-z0-9-]+)?$"
        },
        "feature_name": {
          "type": "string",
          "description": "Human-readable feature name",
          "minLength": 5,
          "maxLength": 200
        },
        "feature_path": {
          "type": "string",
          "description": "Path to feature definition file (will be converted to GitHub permalink in output)"
        },
        "feature_permalink": {
          "type": "string",
          "format": "uri",
          "description": "GitHub permalink to the feature definition file"
        },
        "capabilities_included": {
          "type": "array",
          "description": "Specific capability IDs to include (cap-XXX). If empty, all capabilities included.",
          "items": {
            "type": "string",
            "pattern": "^cap-\\d{3}$"
          }
        },
        "priority": {
          "type": "string",
          "enum": ["must-have", "should-have", "nice-to-have"],
          "description": "Implementation priority for this feature in MVP scope"
        },
        "existing_implementation": {
          "$ref": "#/definitions/existing_implementation",
          "description": "Details about existing implementation if this feature has prior work"
        }
      }
    },

    "existing_implementation": {
      "type": "object",
      "description": "Details about existing implementation for features with prior work",
      "properties": {
        "has_existing": {
          "type": "boolean",
          "description": "Whether this feature has any existing implementation"
        },
        "current_state": {
          "type": "string",
          "description": "Description of the current implementation state",
          "minLength": 20,
          "maxLength": 2000
        },
        "maturity_level": {
          "type": "string",
          "enum": ["prototype", "mvp", "production", "mature"],
          "description": "Maturity level of existing implementation"
        },
        "code_references": {
          "type": "array",
          "description": "References to existing code locations",
          "items": {
            "type": "object",
            "properties": {
              "location": {
                "type": "string",
                "description": "File path, module, or service name (e.g., 'libs/lib-api/src/auth/', 'api-id service')"
              },
              "description": {
                "type": "string",
                "description": "What this code does relevant to the feature"
              },
              "relevance": {
                "type": "string",
                "enum": ["extend", "modify", "replace", "reference"],
                "description": "How this relates to new implementation: extend (add to), modify (change), replace (rewrite), reference (use as-is)"
              }
            }
          }
        },
        "limitations": {
          "type": "array",
          "description": "Current limitations or gaps in existing implementation",
          "items": {
            "type": "string"
          }
        },
        "technical_debt": {
          "type": "array",
          "description": "Known technical debt that affects this feature",
          "items": {
            "type": "string"
          }
        }
      }
    },

    "implementation_delta": {
      "type": "object",
      "description": "Changes and progression compared to existing implementation",
      "properties": {
        "delta_summary": {
          "type": "string",
          "description": "High-level summary of what's changing",
          "minLength": 50,
          "maxLength": 1000
        },
        "capability_changes": {
          "type": "array",
          "description": "Per-capability change details",
          "items": {
            "type": "object",
            "properties": {
              "capability_id": {
                "type": "string",
                "pattern": "^cap-\\d{3}$"
              },
              "change_type": {
                "type": "string",
                "enum": ["new", "enhanced", "refactored", "unchanged"],
                "description": "Type of change: new (doesn't exist), enhanced (adding functionality), refactored (same functionality, different implementation), unchanged (no changes)"
              },
              "description": {
                "type": "string",
                "description": "What specifically is changing for this capability"
              }
            }
          }
        },
        "breaking_changes": {
          "type": "array",
          "description": "Changes that may break existing functionality or integrations",
          "items": {
            "type": "object",
            "properties": {
              "change": {
                "type": "string",
                "description": "What is breaking"
              },
              "impact": {
                "type": "string",
                "description": "What is affected by this breaking change"
              },
              "migration_path": {
                "type": "string",
                "description": "How to handle the transition"
              }
            }
          }
        },
        "migrations_required": {
          "type": "array",
          "description": "Data or schema migrations needed",
          "items": {
            "type": "object",
            "properties": {
              "type": {
                "type": "string",
                "enum": ["database", "data", "config", "api", "other"],
                "description": "Type of migration"
              },
              "description": {
                "type": "string",
                "description": "What needs to be migrated"
              },
              "complexity": {
                "type": "string",
                "enum": ["trivial", "moderate", "complex"],
                "description": "Migration complexity estimate"
              },
              "reversible": {
                "type": "boolean",
                "description": "Whether migration can be rolled back"
              }
            }
          }
        },
        "backwards_compatibility": {
          "type": "object",
          "description": "Backwards compatibility requirements",
          "properties": {
            "required": {
              "type": "boolean",
              "description": "Whether backwards compatibility is required"
            },
            "duration": {
              "type": "string",
              "description": "How long backwards compatibility must be maintained (e.g., '2 releases', '6 months')"
            },
            "approach": {
              "type": "string",
              "description": "How backwards compatibility will be achieved"
            }
          }
        }
      }
    },

    "value_model_component": {
      "type": "object",
      "description": "A selected value model component receiving value from the implementation",
      "required": ["track", "layer_id", "component_id"],
      "properties": {
        "track": {
          "type": "string",
          "enum": ["Product", "Strategy", "OrgOps", "Commercial"],
          "description": "Value model track"
        },
        "layer_id": {
          "type": "string",
          "description": "L1 layer ID (e.g., core-platform)"
        },
        "layer_name": {
          "type": "string",
          "description": "L1 layer display name"
        },
        "component_id": {
          "type": "string",
          "description": "L2 component ID"
        },
        "component_name": {
          "type": "string",
          "description": "L2 component display name"
        },
        "sub_components": {
          "type": "array",
          "description": "Specific L3 sub-components being delivered",
          "items": {
            "type": "object",
            "properties": {
              "id": { "type": "string" },
              "name": { "type": "string" },
              "status_before": {
                "type": "string",
                "enum": ["planned", "active", "deprecated"],
                "description": "Current activation status"
              },
              "status_after": {
                "type": "string",
                "enum": ["planned", "active", "deprecated"],
                "description": "Expected status after implementation"
              }
            }
          }
        }
      }
    },

    "calibration_input": {
      "type": "object",
      "description": "Calibration inputs for implementation ambition and constraints",
      "required": ["scope_level", "timeline_pressure", "quality_expectations"],
      "properties": {
        "scope_level": {
          "type": "string",
          "enum": ["mvp", "functional", "polished", "enterprise"],
          "description": "Target scope level: mvp (minimal viable), functional (complete but basic), polished (high quality UX), enterprise (full production hardened)"
        },
        "timeline_pressure": {
          "type": "string",
          "enum": ["relaxed", "normal", "aggressive", "critical"],
          "description": "Timeline pressure level affecting trade-off decisions"
        },
        "quality_expectations": {
          "type": "object",
          "description": "Quality dimension expectations",
          "properties": {
            "test_coverage": {
              "type": "string",
              "enum": ["minimal", "standard", "comprehensive"],
              "description": "Expected test coverage level"
            },
            "documentation": {
              "type": "string",
              "enum": ["minimal", "standard", "comprehensive"],
              "description": "Expected documentation level"
            },
            "performance": {
              "type": "string",
              "enum": ["acceptable", "optimized", "enterprise-grade"],
              "description": "Performance requirements"
            },
            "security": {
              "type": "string",
              "enum": ["basic", "standard", "hardened"],
              "description": "Security posture requirements"
            }
          }
        },
        "constraints": {
          "type": "array",
          "description": "Explicit constraints on implementation",
          "items": {
            "type": "object",
            "properties": {
              "type": {
                "type": "string",
                "enum": ["technical", "timeline", "resource", "compliance", "dependency", "business"],
                "description": "Type of constraint"
              },
              "description": {
                "type": "string",
                "description": "Constraint description",
                "minLength": 20,
                "maxLength": 500
              },
              "impact": {
                "type": "string",
                "enum": ["blocking", "significant", "moderate", "minor"],
                "description": "Impact level on implementation"
              }
            }
          }
        },
        "deferred_scope": {
          "type": "array",
          "description": "Explicitly deferred items for future iterations",
          "items": {
            "type": "object",
            "properties": {
              "item": {
                "type": "string",
                "description": "What is being deferred",
                "minLength": 10,
                "maxLength": 200
              },
              "rationale": {
                "type": "string",
                "description": "Why it's deferred",
                "minLength": 20,
                "maxLength": 500
              },
              "future_consideration": {
                "type": "string",
                "description": "When/how to reconsider",
                "maxLength": 200
              }
            }
          }
        }
      }
    },

    "tech_stack_context": {
      "type": "object",
      "description": "Technology stack context and integration points",
      "properties": {
        "primary_services": {
          "type": "array",
          "description": "Primary services/apps affected",
          "items": {
            "type": "object",
            "properties": {
              "name": { "type": "string", "description": "Service name (e.g., api, web, worker)" },
              "impact": {
                "type": "string",
                "enum": ["primary", "integration", "minimal"],
                "description": "Impact level on this service"
              },
              "notes": { "type": "string", "description": "Implementation notes for this service" }
            }
          }
        },
        "external_integrations": {
          "type": "array",
          "description": "External services/APIs to integrate",
          "items": {
            "type": "object",
            "properties": {
              "name": { "type": "string", "description": "Integration name (e.g., Signicat, Auth0)" },
              "purpose": { "type": "string", "description": "Why this integration is needed" },
              "existing": { "type": "boolean", "description": "Whether integration already exists" },
              "reuse_patterns": { "type": "string", "description": "Existing patterns to reuse" }
            }
          }
        },
        "data_stores": {
          "type": "array",
          "description": "Database/storage impacts",
          "items": {
            "type": "object",
            "properties": {
              "store": { "type": "string", "description": "Store name (e.g., PostgreSQL, Redis)" },
              "changes": { "type": "string", "description": "Expected changes (new tables, indices, etc.)" }
            }
          }
        }
      }
    },

    "engineering_questions": {
      "type": "array",
      "description": "Open questions for engineering review",
      "items": {
        "type": "object",
        "required": ["question", "context"],
        "properties": {
          "question": {
            "type": "string",
            "description": "The question for engineering to address",
            "minLength": 20,
            "maxLength": 500
          },
          "context": {
            "type": "string",
            "description": "Context explaining why this question matters",
            "minLength": 20,
            "maxLength": 1000
          },
          "decision_impact": {
            "type": "string",
            "enum": ["architecture", "scope", "timeline", "quality", "integration"],
            "description": "What type of decision this affects"
          },
          "suggested_options": {
            "type": "array",
            "description": "Potential options if known",
            "items": { "type": "string" }
          }
        }
      }
    }
  },

  "required": [
    "brief_title",
    "brief_summary",
    "features",
    "value_model_components",
    "calibration"
  ],

  "properties": {
    "metadata": {
      "$ref": "#/definitions/metadata"
    },

    "brief_title": {
      "type": "string",
      "description": "Clear, descriptive title for the engineering brief",
      "minLength": 10,
      "maxLength": 100,
      "examples": ["Digital Identity Security Features - Engineering Brief", "Invoice Automation v2 - Engineering Brief"]
    },

    "brief_summary": {
      "type": "string",
      "description": "2-4 sentence executive summary of what's being built and why",
      "minLength": 50,
      "maxLength": 1000
    },

    "features": {
      "type": "array",
      "description": "Selected feature definitions to implement",
      "items": { "$ref": "#/definitions/feature_selection" },
      "minItems": 1,
      "maxItems": 10
    },

    "value_model_components": {
      "type": "array",
      "description": "Value model components receiving value from this implementation",
      "items": { "$ref": "#/definitions/value_model_component" },
      "minItems": 1
    },

    "related_key_results": {
      "type": "array",
      "description": "Roadmap Key Results this implementation advances",
      "items": {
        "type": "object",
        "properties": {
          "kr_id": {
            "type": "string",
            "pattern": "^kr-[psoc]-\\d{3}$",
            "description": "Key Result ID from roadmap"
          },
          "kr_title": { "type": "string" },
          "contribution": {
            "type": "string",
            "description": "How this implementation contributes to the KR"
          }
        }
      }
    },

    "calibration": {
      "$ref": "#/definitions/calibration_input"
    },

    "tech_stack": {
      "$ref": "#/definitions/tech_stack_context"
    },

    "implementation_delta": {
      "$ref": "#/definitions/implementation_delta",
      "description": "Overall implementation delta when features have existing implementations"
    },

    "implementation_considerations": {
      "type": "array",
      "description": "Key implementation considerations and patterns to follow",
      "items": {
        "type": "object",
        "properties": {
          "area": {
            "type": "string",
            "description": "Implementation area (e.g., 'Identity Matching', 'Audit Trail')"
          },
          "consideration": {
            "type": "string",
            "description": "What needs to be considered and why"
          },
          "recommendation": {
            "type": "string",
            "description": "Recommended approach or pattern"
          }
        }
      }
    },

    "engineering_questions": {
      "$ref": "#/definitions/engineering_questions"
    },

    "success_criteria": {
      "type": "array",
      "description": "Measurable success criteria for the implementation",
      "items": {
        "type": "object",
        "properties": {
          "criterion": { "type": "string", "description": "What success looks like" },
          "measurement": { "type": "string", "description": "How to measure it" },
          "target": { "type": "string", "description": "Target value/threshold" }
        }
      }
    },

    "artifact_links": {
      "type": "object",
      "description": "Direct links to EPF artifacts for engineering reference",
      "properties": {
        "feature_definitions": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "path": { "type": "string" },
              "description": { "type": "string" }
            }
          }
        },
        "value_models": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "path": { "type": "string" },
              "description": { "type": "string" }
            }
          }
        },
        "roadmap": {
          "type": "object",
          "properties": {
            "path": { "type": "string" },
            "relevant_sections": { "type": "array", "items": { "type": "string" } }
          }
        },
        "supplementary": {
          "type": "array",
          "description": "Additional relevant artifacts",
          "items": {
            "type": "object",
            "properties": {
              "path": { "type": "string" },
              "description": { "type": "string" }
            }
          }
        }
      }
    }
  }
}
