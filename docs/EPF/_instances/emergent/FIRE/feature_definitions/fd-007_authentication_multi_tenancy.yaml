id: 'fd-007'
name: 'Authentication & Multi-Tenancy'
slug: 'authentication-multi-tenancy'
status: 'delivered'

strategic_context:
  contributes_to:
    - 'Product.Layer3PlatformServices.WorkspaceIsolation.AccessControl'
    - 'Product.Layer3PlatformServices.WorkspaceIsolation.TenantProvisioning'
  tracks:
    - 'product'
  assumptions_tested:
    - 'asm-p-013' # Organization-level isolation prevents data leakage
    - 'asm-p-014' # Project-level granularity provides sufficient flexibility
    - 'asm-p-015' # Invite-based onboarding reduces friction

definition:
  job_to_be_done: |
    When I'm working with sensitive organizational data,
    I want strict tenant isolation and secure authentication,
    so I'm confident my data is protected and only accessible to authorized users.

  solution_approach: |
    A multi-tenant architecture with:
    - OIDC authentication via Zitadel
    - Three-tier hierarchy: Organization → Project → User
    - Row-level security (RLS) enforced at database layer
    - API key-based programmatic access
    - Invite-based user onboarding with role management

  personas:
    - id: 'security-administrator'
      name: 'Security Administrator'
      role: 'IT Security Manager responsible for access control'
      description: >
        An IT security professional who manages authentication policies,
        monitors access patterns, and ensures the organization meets
        compliance requirements for data protection.
      goals:
        - 'Enforce strict access control policies across all organizational data'
        - 'Monitor authentication events for suspicious activity patterns'
        - 'Ensure compliance with security standards like SOC 2 and GDPR'
      pain_points:
        - 'Inconsistent authentication across applications creates security gaps'
        - 'Manual access reviews are time-consuming and error-prone'
        - 'Lack of audit trails makes incident investigation difficult'
      usage_context: >
        Configures authentication policies, reviews access logs, and responds
        to security alerts related to authentication and authorization events.
      technical_proficiency: 'advanced'
      current_situation: >
        As a security administrator, I manage access control across dozens of applications, each with its own
        authentication system and user directory. When an employee leaves the company, I have to manually revoke access
        in each system, and inevitably something gets missed. Security audits are stressful because I have to compile
        access logs from multiple sources, and gaps in our audit trail make it impossible to answer questions like
        "who accessed this data last month?" The lack of centralized authentication means I cannot enforce consistent
        password policies or MFA requirements, leaving our organization vulnerable to credential-based attacks.
      transformation_moment: >
        The first time I configured the Authentication & Multi-Tenancy system, I was impressed by the centralized
        approach to identity management. The OIDC integration with Zitadel meant I could enforce organization-wide
        authentication policies from a single dashboard. When I ran my first access audit, the comprehensive logs showed
        every authentication event with user, timestamp, and context—exactly what compliance auditors want to see. The
        row-level security policies gave me confidence that tenant isolation was enforced at the database layer, not
        just the application layer.
      emotional_resolution: >
        After adopting the Authentication & Multi-Tenancy system, I feel in control of our organization's security
        posture for the first time. User provisioning and deprovisioning happens through a single workflow, and I can
        prove compliance with clear audit trails. The centralized authentication policies mean I know exactly what
        security controls are in place, and the real-time monitoring alerts me to suspicious activity before it becomes
        a breach. Security audits have transformed from stressful scrambles into routine demonstrations of our robust
        access controls.
      demographics:
        age_range: '30-50'
        experience_years: '8-20 years in IT security or information security'
        company_size: 'Mid-market to Enterprise (500-20,000 employees)'
        industry:
          ['Financial Services', 'Healthcare', 'Technology', 'Government']
        geography: 'Regulated industries with strict compliance requirements'
        education: "Bachelor's in Computer Science or Cybersecurity, often with certifications (CISSP, CISM, CISA)"
        reporting_structure: 'Reports to CISO, VP of IT, or Chief Compliance Officer'
      psychographics:
        values:
          [
            'Security',
            'Compliance',
            'Risk mitigation',
            'Operational discipline',
          ]
        motivations:
          [
            'Protect organizational data',
            'Pass security audits',
            'Prevent breaches',
            'Enable secure productivity',
          ]
        fears:
          [
            'Data breaches',
            'Compliance failures',
            'Stale access permissions',
            'Incomplete audit trails',
          ]
        decision_style: 'Risk-averse and compliance-focused, requires clear evidence and audit capabilities'
        information_sources:
          [
            'Security advisories',
            'Compliance frameworks (SOC 2, GDPR)',
            'Vendor security documentation',
            'CISO forums',
            'Penetration test reports',
          ]
        communication_preferences: 'Security documentation, audit reports, incident reports, compliance dashboards'

    - id: 'tenant-administrator'
      name: 'Tenant Administrator'
      role: 'Organization Admin managing users and projects'
      description: >
        A team lead or department manager who administers their organization's
        users, projects, and access permissions without requiring IT support
        for routine operations.
      goals:
        - 'Quickly onboard new team members with appropriate access levels'
        - 'Manage project-level permissions without technical assistance'
        - 'Maintain visibility into who has access to what within my organization'
      pain_points:
        - 'Waiting for IT to provision new user accounts delays onboarding'
        - 'Understanding current access permissions requires spreadsheet tracking'
        - 'Revoking access when team members change roles is often forgotten'
      usage_context: >
        Uses the admin interface to invite team members, create projects, and
        manage role assignments for their organization.
      technical_proficiency: 'intermediate'
      current_situation: >
        As an organization administrator, I struggle with the complexity of managing my team's access to our knowledge
        base. When a new team member joins, I have to submit a ticket to IT and wait days for their account to be
        provisioned. I maintain a spreadsheet to track who has access to what because there is no clear visibility into
        current permissions. When someone changes roles or leaves the team, I often forget to update their access
        because the process requires coordinating with multiple people. This leads to security risks and compliance
        concerns that keep me up at night.
      transformation_moment: >
        The first time I used the self-service admin interface, I invited a new team member and watched them join my
        organization within minutes—no IT tickets, no waiting. The clear role-based access control showed me exactly
        what each permission level grants, and I could assign the right role with confidence. When I checked the member
        list, I could see everyone's current access level at a glance, along with when they last logged in. Removing
        access when someone left the team was a single click, and I received confirmation that their access was revoked
        immediately.
      emotional_resolution: >
        After adopting the Authentication & Multi-Tenancy system, I feel empowered to manage my organization without
        depending on IT for routine operations. Onboarding new team members takes minutes instead of days, and I always
        know exactly who has access to our projects. The invite-based workflow means I control who joins my
        organization, and the clear role hierarchy removes all ambiguity about permissions. I no longer worry about
        stale access or forgotten accounts because the system makes good security practices effortless.
      demographics:
        age_range: '32-50'
        experience_years: '8-20 years, including 3+ years managing teams'
        company_size: 'Mid-market to Enterprise (200-10,000 employees)'
        industry:
          [
            'Technology',
            'Professional Services',
            'Financial Services',
            'Healthcare',
          ]
        geography: 'Department or team level with organizational scope'
        education: "Bachelor's in Business, Engineering, or related field"
        reporting_structure: 'Reports to Director, VP, or C-level executive while managing direct reports'
      psychographics:
        values:
          [
            'Team productivity',
            'Operational efficiency',
            'Security consciousness',
            'Self-service capability',
          ]
        motivations:
          [
            'Onboard team members quickly',
            'Maintain access control',
            'Reduce IT dependencies',
            'Focus on team work not admin tasks',
          ]
        fears:
          [
            'Security risks from stale access',
            'Slow onboarding',
            'Permission confusion',
            'Compliance issues from poor access management',
          ]
        decision_style: 'Practical and efficiency-focused, values self-service over support tickets'
        information_sources:
          [
            'Admin interfaces',
            'IT documentation',
            'Team feedback',
            'Security policies',
            'Manager peers',
          ]
        communication_preferences: 'Clear UI workflows, email confirmations, self-service documentation'

    - id: 'enterprise-buyer'
      name: 'Enterprise Buyer'
      role: 'IT Procurement Manager evaluating security requirements'
      description: >
        A procurement professional evaluating the platform for enterprise
        deployment, focused on security certifications, compliance capabilities,
        and integration with existing identity infrastructure.
      goals:
        - 'Verify the platform meets enterprise security and compliance requirements'
        - 'Understand how tenant isolation protects organizational data'
        - 'Confirm integration capability with existing identity providers'
      pain_points:
        - 'Security questionnaires from vendors are often incomplete or evasive'
        - 'Understanding actual data isolation architecture requires deep dives'
        - 'Evaluating SSO integration complexity before procurement is difficult'
      usage_context: >
        Reviews security documentation, requests architecture details, and
        validates compliance certifications during the procurement process.
      technical_proficiency: 'intermediate'
      current_situation: >
        As an IT procurement manager, I evaluate dozens of SaaS platforms each year, and security assessment is always
        the bottleneck. Vendors provide vague answers to security questionnaires, and I have to schedule multiple calls
        to understand their actual data isolation architecture. Most platforms claim "enterprise-grade security" but
        cannot explain how they prevent data leakage between tenants. When I ask about SSO integration, I often discover
        hidden complexity that will require months of professional services. The lack of transparency makes procurement
        decisions feel like gambling with organizational data.
      transformation_moment: >
        The first time I reviewed the Authentication & Multi-Tenancy documentation, I found clear, detailed explanations
        of the security architecture. The row-level security implementation at the PostgreSQL layer was documented with
        actual policy examples, not hand-wavy marketing claims. The OIDC integration with Zitadel meant standard SSO
        protocols that my team already understands. When I asked technical questions, I received architecture diagrams
        and threat models instead of sales pitches. For once, a vendor's security claims were substantiated with
        verifiable technical details.
      emotional_resolution: >
        After completing my security evaluation of the Authentication & Multi-Tenancy system, I feel confident
        recommending the platform to my organization. The transparent security architecture and comprehensive
        documentation answered every question on our security checklist. I can clearly explain to stakeholders how our
        data will be protected and isolated from other tenants. The procurement process was refreshingly
        straightforward, and I trust that the platform will meet our compliance requirements because the evidence is
        clear and verifiable.
      demographics:
        age_range: '35-55'
        experience_years: '10-25 years in IT procurement, vendor management, or IT leadership'
        company_size: 'Enterprise (1,000-50,000 employees)'
        industry:
          [
            'Financial Services',
            'Healthcare',
            'Government',
            'Large Technology companies',
          ]
        geography: 'Corporate IT with global procurement responsibilities'
        education: "Bachelor's or Master's in Business, IT Management, or related field; often with procurement certifications"
        reporting_structure: 'Reports to CIO, VP of IT, or Chief Procurement Officer'
      psychographics:
        values:
          [
            'Due diligence',
            'Risk management',
            'Vendor transparency',
            'Value for investment',
          ]
        motivations:
          [
            'Make sound procurement decisions',
            'Protect organization from vendor risk',
            'Simplify security evaluations',
            'Enable business capabilities safely',
          ]
        fears:
          [
            'Choosing insecure vendors',
            'Hidden security weaknesses',
            'Costly remediation post-purchase',
            'Stakeholder blame for bad decisions',
          ]
        decision_style: 'Evidence-based and thorough, requires documented proof of security claims'
        information_sources:
          [
            'Security questionnaires',
            'Vendor documentation',
            'Third-party audits (SOC 2 reports)',
            'Analyst reports',
            'Reference customers',
          ]
        communication_preferences: 'Detailed security documentation, architecture diagrams, compliance certifications, executive summaries'

    - id: 'compliance-officer'
      name: 'Compliance Officer'
      role: 'Regulatory Compliance Manager ensuring audit readiness'
      description: >
        A compliance professional responsible for ensuring the organization
        meets regulatory requirements for data protection, access control,
        and audit trails.
      goals:
        - 'Demonstrate compliance with regulatory requirements during audits'
        - 'Maintain comprehensive audit trails for all data access'
        - 'Ensure data residency and isolation requirements are met'
      pain_points:
        - 'Gathering evidence for compliance audits requires manual effort'
        - 'Incomplete audit logs make demonstrating compliance difficult'
        - 'Understanding third-party platform compliance is time-consuming'
      usage_context: >
        Reviews audit logs, generates compliance reports, and validates that
        access controls meet regulatory requirements.
      technical_proficiency: 'basic'
      current_situation: >
        As a compliance officer, I spend significant time gathering evidence for regulatory audits, and access control
        documentation is always the most challenging area. Our current systems have fragmented audit logs that require
        manual correlation to answer questions like "who accessed customer data in the past quarter?" The lack of clear
        tenant isolation documentation makes it difficult to prove data segregation to auditors. Every audit cycle
        involves scrambling to compile evidence from multiple sources, and I often discover gaps that require remediation
        plans. The stress of audit preparation affects my entire team for weeks leading up to each review.
      transformation_moment: >
        The first time I explored the Authentication & Multi-Tenancy audit capabilities, I found exactly what auditors
        want to see—comprehensive logs of every authentication event, permission change, and data access. The row-level
        security documentation provided clear evidence of tenant isolation that I could present directly to auditors.
        When I generated my first compliance report, it included all the access control evidence I needed in a format
        auditors recognize. The system-generated documentation answered compliance questions I usually spend days
        researching manually.
      emotional_resolution: >
        After adopting the Authentication & Multi-Tenancy system, I feel prepared for audits instead of dreading them.
        The comprehensive audit trails and clear security architecture make compliance demonstration straightforward.
        Auditors appreciate the quality of our documentation, and reviews complete faster with fewer findings. I can
        confidently attest to our access control posture because the evidence is always current and complete. Compliance
        has shifted from a stressful obligation to a natural outcome of how the system operates.
      demographics:
        age_range: '32-55'
        experience_years: '8-20 years in compliance, legal, or risk management'
        company_size: 'Mid-market to Enterprise (500-50,000 employees)'
        industry:
          [
            'Financial Services',
            'Healthcare',
            'Pharmaceuticals',
            'Government',
            'Insurance',
          ]
        geography: 'Regulated industries with formal compliance programs'
        education: "Bachelor's or advanced degree in Law, Business, or related field; often with compliance certifications (CIPP, CRISC, CISA)"
        reporting_structure: 'Reports to Chief Compliance Officer, General Counsel, or Audit Committee'
      psychographics:
        values:
          ['Compliance', 'Documentation', 'Auditability', 'Risk awareness']
        motivations:
          [
            'Pass audits smoothly',
            'Demonstrate compliance posture',
            'Reduce audit findings',
            'Protect organization from regulatory risk',
          ]
        fears:
          [
            'Audit failures',
            'Incomplete evidence',
            'Regulatory fines',
            'Personal liability for compliance gaps',
          ]
        decision_style: 'Evidence-oriented, requires documented proof and audit trails for all claims'
        information_sources:
          [
            'Regulatory guidance',
            'Audit standards',
            'Compliance frameworks',
            'Legal counsel',
            'Industry peer groups',
          ]
        communication_preferences: 'Formal documentation, audit reports, compliance dashboards, written attestations'

  capabilities:
    - id: 'cap-032'
      name: 'OIDC Authentication'
      description: 'Secure login via Zitadel with JWT token validation'

    - id: 'cap-033'
      name: 'Organization Management'
      description: 'Create and manage isolated organizations'

    - id: 'cap-034'
      name: 'Project Isolation'
      description: 'Project-level data boundaries within organizations'

    - id: 'cap-035'
      name: 'Row-Level Security'
      description: 'PostgreSQL RLS policies enforce tenant isolation'

    - id: 'cap-036'
      name: 'Role-Based Access Control'
      description: 'Granular permissions via organization roles'

    - id: 'cap-037'
      name: 'Invite Management'
      description: 'Email-based user invitations with expiration'

implementation:
  design_guidance:
    principles:
      - 'Security by default (RLS always enabled except for service accounts)'
      - 'Fail closed (missing tenant context = reject request)'
      - 'Audit all (log authentication events and permission checks)'
      - 'Least privilege (roles grant minimum necessary permissions)'

    inspirations:
      - 'Auth0 multi-tenancy patterns'
      - 'PostgreSQL RLS best practices (Supabase)'
      - 'Zitadel OIDC integration guides'

  contexts:
    - id: 'ctx-015'
      type: 'ui'
      name: 'User Login'
      description: 'User authenticates via Zitadel OIDC'
      key_interactions:
        - "Click 'Sign In' button to initiate login"
        - 'Enter credentials on Zitadel login page'
        - 'Complete SSO flow if configured'
        - 'Receive JWT token after successful authentication'
      data_displayed:
        - 'Sign in button and branding'
        - 'Zitadel login form (email/password or SSO)'
        - 'Error messages for failed authentication'
        - 'Loading state during token exchange'

    - id: 'ctx-016'
      type: 'api'
      name: 'Project API Key Access'
      description: 'Developer uses API key for programmatic access'
      key_interactions:
        - 'Send API request with Bearer token header'
        - 'Validate API key against project_api_keys table'
        - 'Set project context from validated key'
        - 'Apply RLS policies automatically'
      data_displayed:
        - 'API response with project-scoped data'
        - 'Error responses for invalid/expired keys'
        - 'Rate limit headers'

    - id: 'ctx-017'
      type: 'api'
      name: 'Invite User'
      description: 'Admin invites new user to organization'
      key_interactions:
        - 'POST invite request with email and role'
        - 'Generate invite token (UUID)'
        - 'Send email with invite link'
        - 'Accept invite via link and complete signup'
      data_displayed:
        - 'Invite confirmation response'
        - 'Invite status (pending, accepted, expired)'
        - 'Organization and role information'

  scenarios:
    - id: 'scn-018'
      name: 'First-Time Login'
      actor: 'New user'
      context: 'User is accessing the application for the first time after being invited'
      trigger: "User clicks 'Sign In' button on landing page"
      action: 'Completes OIDC authentication flow via Zitadel'
      outcome: 'User profile created and lands on dashboard with correct tenant context'
      acceptance_criteria:
        - 'JWT signature verified'
        - 'User profile created in core.users'
        - 'User assigned to default organization'
        - 'Dashboard loads with correct tenant context'

    - id: 'scn-019'
      name: 'API Key Authentication'
      actor: 'Integration system'
      context: 'External script needs to query project data programmatically'
      trigger: 'Script sends API request with project API key'
      action: 'System validates API key and applies project scope'
      outcome: 'Response contains only project-scoped data with RLS applied'
      acceptance_criteria:
        - 'API key validated against kb.project_api_keys'
        - 'Project context set from key'
        - 'RLS policies applied automatically'
        - 'Response scoped to project data only'

    - id: 'scn-020'
      name: 'Send Organization Invite'
      actor: 'Organization admin'
      context: 'Admin needs to add a new team member to the organization'
      trigger: 'Admin submits invite form with email and role'
      action: 'Creates invite and sends email with acceptance link'
      outcome: 'Recipient receives email and can join organization via link'
      acceptance_criteria:
        - 'Invite created in core.invites'
        - 'Token generated (UUID)'
        - 'Email sent with invite link'
        - 'Link expires in 7 days'

boundaries:
  non_goals:
    - 'Not a full identity provider (delegates to Zitadel)'
    - 'Not a SAML-based SSO solution (OIDC only)'
    - 'Not a fine-grained permission system (role-based only)'

  constraints:
    - 'Depends on Zitadel availability for login'
    - 'Single role per user per organization'
    - 'API keys tied to single project'

dependencies:
  requires: []
  enables:
    - id: 'fd-001'
      name: 'Knowledge Graph Engine'
      reason: 'Graph data requires tenant isolation and user authentication for access control'
    - id: 'fd-002'
      name: 'Document Ingestion Pipeline'
      reason: 'Document processing requires project context for storage and access control'
    - id: 'fd-003'
      name: 'AI Native Chat'
      reason: 'Chat requires user context for personalization and access control'
