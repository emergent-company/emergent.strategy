# Migration Guide: v1.x → v2.0.0

> **Migration Type**: MAJOR  
> **Estimated Effort**: 1-3 hours per feature definition  
> **Breaking Changes**: Yes - feature definition structure

## Overview

EPF v2.0.0 introduces significant changes to feature definitions to improve persona modeling and scenario clarity. This guide covers migrating from any v1.x version to v2.0.0.

## Breaking Changes Summary

| Change | Old (v1.x) | New (v2.0) | Impact |
|--------|------------|------------|--------|
| Personas | `value_propositions[]` | `personas[]` with narratives | HIGH - restructure required |
| Scenarios | `definition.scenarios[]` | `scenarios[]` (top-level) | MEDIUM - move to root |
| Persona Count | Variable | Exactly 4 | MEDIUM - must add/merge |
| Narrative Length | Any | 200+ chars each | LOW - expand existing |

---

## Change 1: Personas Restructure {#personas}

### What Changed

The `value_propositions` array has been replaced with `personas` array that requires narrative storytelling fields.

### Before (v1.x)

```yaml
value_propositions:
  - stakeholder: "System Administrator"
    value: "Reduces time spent on user management"
  - stakeholder: "End User"
    value: "Easier access to resources"
```

### After (v2.0)

```yaml
personas:
  - persona_type: "power_user"
    current_situation: |
      Maria is a system administrator at a mid-size company managing 
      200+ user accounts. Every morning, she spends 2-3 hours processing 
      access requests, password resets, and permission changes. The manual 
      workflow involves multiple systems that don't communicate, leading 
      to errors and frustrated employees waiting for access. She feels 
      overwhelmed and reactive rather than strategic. (200+ chars)
    transformation_moment: |
      With automated user provisioning, Maria's morning routine transforms 
      completely. Access requests are processed automatically based on 
      role definitions. New employees get the right permissions on day one. 
      The system handles password resets through self-service. Maria now 
      reviews a dashboard instead of processing tickets. (200+ chars)
    emotional_resolution: |
      Maria now arrives at work feeling empowered rather than dreading 
      the inbox. She's shifted from reactive firefighting to proactive 
      security improvements. Her expertise is valued for strategic 
      decisions rather than routine tasks. She's even been promoted to 
      Security Architect because she had time to develop new skills. (200+ chars)

  - persona_type: "casual_user"
    current_situation: |
      ... (200+ chars describing employee experience)
    transformation_moment: |
      ... (200+ chars describing the change)
    emotional_resolution: |
      ... (200+ chars describing the outcome)

  - persona_type: "decision_maker"
    current_situation: |
      ... (200+ chars)
    transformation_moment: |
      ... (200+ chars)
    emotional_resolution: |
      ... (200+ chars)

  - persona_type: "technical_user"
    current_situation: |
      ... (200+ chars)
    transformation_moment: |
      ... (200+ chars)
    emotional_resolution: |
      ... (200+ chars)
```

### Migration Steps

1. **Map stakeholders to persona types**:
   | Old Stakeholder | New Persona Type |
   |-----------------|------------------|
   | Admin, Administrator, Power User | `power_user` |
   | User, End User, Customer | `casual_user` |
   | Manager, Executive, Director | `decision_maker` |
   | Developer, Engineer, Technical | `technical_user` |

2. **Expand each value to three narratives**:
   - `current_situation`: What's the pain? Include emotional context, time wasted, frustration
   - `transformation_moment`: What changes? Be specific about the shift in workflow
   - `emotional_resolution`: What's the outcome? Include personal/professional growth

3. **Ensure exactly 4 personas**:
   - If you have fewer, add missing persona types
   - If you have more, merge similar ones or pick most important

4. **Meet minimum length** (200+ characters each):
   - Use the narrative template above as a guide
   - Include specific details, not generic statements

### AI Instructions for This Migration

```
When converting value_propositions to personas:

1. READ the existing value_propositions array completely
2. CREATE a personas array with exactly 4 entries
3. MAP each value_proposition to the closest persona_type:
   - power_user: administrative users, system operators
   - casual_user: regular end users, customers
   - decision_maker: managers, executives, approvers
   - technical_user: developers, engineers, integrators
   
4. EXPAND each original "value" into three narrative fields:
   
   current_situation (200+ chars):
   - Start with a name to humanize
   - Describe specific daily pain points
   - Include time/effort metrics if available
   - Add emotional context (frustrated, overwhelmed, etc.)
   
   transformation_moment (200+ chars):
   - Describe the specific change in workflow
   - Be concrete about what's different
   - Show the cause-and-effect
   
   emotional_resolution (200+ chars):
   - Describe the positive outcome
   - Include professional growth or recognition
   - End on an aspirational note

5. If fewer than 4 value_propositions:
   - Add relevant persona types based on the feature's nature
   - Consider who else benefits from this feature
   
6. If more than 4 value_propositions:
   - Merge similar stakeholders into one persona
   - Keep the most strategically important ones
   
7. VALIDATE: Each narrative must be 200+ characters
8. REMOVE the old value_propositions field entirely
```

---

## Change 2: Scenarios Top-Level {#scenarios}

### What Changed

Scenarios moved from nested under `definition.scenarios` to a top-level `scenarios` array.

### Before (v1.x)

```yaml
definition:
  core_capabilities:
    - capability: "User management"
  scenarios:
    - id: "sc-001"
      name: "Admin creates user"
      description: "Administrator creates a new user account"
      actors: ["Admin"]
      preconditions: ["Admin is logged in"]
      flow:
        - "Admin navigates to user management"
        - "Admin clicks create user"
        - "Admin fills in user details"
      postconditions: ["User account exists"]
```

### After (v2.0)

```yaml
capabilities:
  - capability: "User management"
    # ... (capabilities stay similar)

scenarios:
  - id: "sc-001"
    name: "Admin creates user"
    actor: "System Administrator"
    context: "IT department onboarding new employee"
    trigger: "New employee joins the company"
    action: |
      Administrator accesses user management, enters employee 
      details (name, email, department, role), and submits 
      the creation request.
    outcome: |
      New user account is created with appropriate role-based 
      permissions. Welcome email is automatically sent to the 
      new employee with login instructions.
    acceptance_criteria:
      - "User account appears in directory within 30 seconds"
      - "Role-based permissions are correctly assigned"
      - "Welcome email is sent with valid login link"
      - "Audit log records the account creation event"
```

### Migration Steps

1. **Move scenarios array** from `definition.scenarios` to document root
2. **Update scenario structure**:
   - `actors` (array) → `actor` (string) - pick primary actor
   - `description` → split into `context` and `trigger`
   - `preconditions` → incorporate into `context`
   - `flow` → consolidate into `action` (narrative paragraph)
   - `postconditions` → split into `outcome` and `acceptance_criteria`
3. **Add acceptance_criteria** (array of testable statements)

### AI Instructions for This Migration

```
When moving scenarios to top-level:

1. LOCATE scenarios at definition.scenarios
2. MOVE entire array to document root level
3. For EACH scenario, transform structure:

   Old field → New field:
   - actors[0] → actor (use primary actor as string)
   - description → context (what situation prompts this?)
   - preconditions → incorporate into context
   - (add) trigger: What specific event starts this scenario?
   - flow[] → action: Combine steps into narrative paragraph
   - postconditions → outcome: Describe the end state
   - (add) acceptance_criteria[]: List testable criteria

4. ENSURE each scenario has all required fields:
   - id (keep existing format)
   - name (keep existing)
   - actor (string)
   - context (string)
   - trigger (string)
   - action (string)
   - outcome (string)
   - acceptance_criteria (array of strings)

5. DELETE the empty definition.scenarios path
6. VALIDATE: All 8 fields present for each scenario
```

---

## Complete Migration Checklist

### Pre-Migration
- [ ] Backup all feature definition files
- [ ] List all files matching `fd-*.yaml`
- [ ] Note current version in each file

### Per Feature Definition
- [ ] Convert `value_propositions` → `personas` (4 required)
- [ ] Each persona has 3 narratives (200+ chars each)
- [ ] Move `scenarios` to top-level
- [ ] Update scenario structure (8 required fields)
- [ ] Update `meta.epf_version` or header comment to `2.0.0`
- [ ] Run schema validation: `./scripts/validate-schemas.sh {file}`
- [ ] Commit with message: `EPF: Migrate {feature-id} to v2.0.0`

### Post-Migration
- [ ] Run full validation: `./scripts/validate-instance.sh _instances/{product}/`
- [ ] Update `_meta.yaml` with migration record
- [ ] Review AI-generated narratives for accuracy

---

## Validation

After migration, validate each file:

```bash
# Single file
./scripts/validate-schemas.sh _instances/{product}/FIRE/feature_definitions/fd-001.yaml

# All feature definitions
./scripts/validate-feature-quality.sh _instances/{product}/FIRE/feature_definitions/

# Full instance
./scripts/validate-instance.sh _instances/{product}/
```

### Common Validation Errors

| Error | Cause | Fix |
|-------|-------|-----|
| `personas: minItems 4` | Fewer than 4 personas | Add missing persona types |
| `current_situation: minLength 200` | Narrative too short | Expand with details |
| `scenarios: required` | Scenarios missing | Add scenarios array at root |
| `acceptance_criteria: required` | Missing criteria | Add testable criteria array |

---

## Example: Complete Before/After

### Before (v1.9.6)

```yaml
# Feature Definition: User Management
# EPF v1.9.6

meta:
  id: "fd-001"
  name: "User Management"

value_propositions:
  - stakeholder: "Admin"
    value: "Reduces user management time"
  - stakeholder: "User"
    value: "Faster access to systems"

definition:
  core_capabilities:
    - capability: "Create users"
    - capability: "Manage permissions"
  scenarios:
    - id: "sc-001"
      description: "Admin creates user"
      actors: ["Admin"]
      flow: ["Navigate to users", "Click create", "Enter details"]
      postconditions: ["User exists"]
```

### After (v2.0.0)

```yaml
# Feature Definition: User Management
# EPF v2.0.0

meta:
  id: "fd-001"
  name: "User Management"
  epf_version: "2.0.0"

personas:
  - persona_type: "power_user"
    current_situation: |
      Alex is an IT administrator responsible for managing 500+ user 
      accounts across multiple systems. Daily tasks include processing 
      access requests, handling password resets, and managing permissions. 
      The fragmented tooling means switching between 4 different admin 
      consoles, leading to errors and 3-hour delays in access provisioning. 
      Alex feels like a bottleneck and worries about security gaps.
    transformation_moment: |
      With unified user management, Alex now works from a single dashboard 
      that synchronizes across all systems. Access requests trigger automated 
      workflows based on role definitions. Self-service password reset 
      eliminates 60% of tickets. Bulk operations handle common tasks in 
      seconds instead of hours. Alex's role shifts from ticket processor 
      to access architect.
    emotional_resolution: |
      Alex has transformed from a reactive ticket handler to a proactive 
      security strategist. The time saved allowed completing a security 
      certification. The IT director now consults Alex on access governance 
      strategy. Alex feels valued for expertise rather than just throughput, 
      and has been recognized as a key contributor to the security team.

  - persona_type: "casual_user"
    current_situation: |
      Sam is a new marketing analyst who joined the company last week. 
      Day one was frustrating—no access to the analytics dashboard, 
      shared drives showed "permission denied", and the CRM login didn't 
      work. Sam spent the first three days emailing IT, waiting for access, 
      and feeling unproductive. The manager is concerned about the slow 
      start and Sam wonders if this chaos is normal here.
    transformation_moment: |
      With role-based automatic provisioning, Sam's experience completely 
      changes. Before the first day, all marketing analyst tools are 
      pre-configured. The welcome email includes single sign-on links to 
      every needed system. Self-service portal allows requesting additional 
      access with manager approval in minutes, not days. Sam is productive 
      from hour one.
    emotional_resolution: |
      Sam feels welcomed and valued from day one. The smooth onboarding 
      signals a well-run organization that respects employee time. Sam is 
      already making contributions in the first week and has recommended 
      the company to former colleagues. The manager is impressed with Sam's 
      quick impact and the streamlined onboarding process.

  - persona_type: "decision_maker"
    current_situation: |
      Jordan is the CISO responsible for access governance across the 
      organization. Quarterly access reviews are a nightmare—spreadsheets 
      exported from 6 different systems, no clear picture of who has 
      access to what. Audit findings repeatedly cite excessive permissions 
      and orphaned accounts. Jordan knows there are compliance risks but 
      lacks visibility to address them. The board is asking questions.
    transformation_moment: |
      Unified access management provides Jordan with real-time visibility 
      into access across all systems. Automated access reviews replace 
      spreadsheet chaos. Anomaly detection flags unusual access patterns. 
      Compliance reports generate automatically for auditors. Jordan can 
      finally answer "who has access to what?" confidently.
    emotional_resolution: |
      Jordan presents to the board with confidence, showing measurable 
      improvements in access governance. Audit findings dropped 80%. 
      The security team is seen as an enabler rather than a blocker. 
      Jordan has budget approval for expanding the security program and 
      feels the organization finally takes security seriously.

  - persona_type: "technical_user"
    current_situation: |
      Riley is a DevOps engineer managing infrastructure access for 
      deployment pipelines. Currently, service accounts are created 
      manually, credentials are stored in various vaults (some just 
      config files), and there's no clear ownership. When a team member 
      leaves, Riley scrambles to identify and rotate affected credentials. 
      The security team keeps asking about service account inventory.
    transformation_moment: |
      API-driven user management integrates with CI/CD pipelines. Service 
      accounts are created programmatically with defined lifecycles. 
      Credential rotation happens automatically. Clear ownership metadata 
      means offboarding triggers automatic credential rotation. Riley 
      can generate service account inventory reports on demand.
    emotional_resolution: |
      Riley's infrastructure is now secure by default rather than secure 
      by heroics. The automation has eliminated weekend credential rotation 
      emergencies. Security team praises the service account governance. 
      Riley has time to work on interesting infrastructure projects instead 
      of access firefighting. Other teams are adopting Riley's patterns.

capabilities:
  - capability: "Create and manage user accounts"
  - capability: "Role-based permission management"

scenarios:
  - id: "sc-001"
    name: "Admin creates new user"
    actor: "IT Administrator"
    context: "New employee onboarding, HR has completed paperwork"
    trigger: "HR system sends new hire notification"
    action: |
      Administrator receives automated notification of new hire. Clicks 
      through to pre-filled user creation form with data from HR system. 
      Selects appropriate role template based on job title. Reviews 
      auto-suggested permissions and adjusts if needed. Submits creation 
      request which triggers provisioning workflow.
    outcome: |
      User account created across all connected systems. Role-based 
      permissions applied automatically. Welcome email sent to new 
      employee with SSO setup instructions. Manager notified of account 
      activation. Audit trail records all actions.
    acceptance_criteria:
      - "Account created in all connected systems within 60 seconds"
      - "Permissions match role template definition"
      - "Welcome email delivered within 5 minutes"
      - "Audit log contains complete provisioning record"
      - "Manager receives notification of account activation"
```

---

## Per-Artifact Validation Checkpoints

**CRITICAL: Validate DURING migration, not just at the end. Fail fast - fix errors before proceeding to the next artifact.**

For EACH feature definition being migrated, run this validation sequence:

### After Completing Personas Migration

```bash
# Check that personas structure is valid
./scripts/validate-schemas.sh _instances/{product}/FIRE/feature_definitions/{file}.yaml

# If validation fails:
# - Check: Do you have exactly 4 personas? (minItems: 4, maxItems: 4)
# - Check: Are all three narrative fields present for each persona?
# - Check: Is each narrative 200+ characters?

# DO NOT proceed to scenarios migration if this fails!
```

### After Completing Scenarios Migration

```bash
# Check that scenarios structure is valid
./scripts/validate-schemas.sh _instances/{product}/FIRE/feature_definitions/{file}.yaml

# If validation fails:
# - Check: Are scenarios at document root (not under definition.scenarios)?
# - Check: Does each scenario have all 8 required fields?
# - Check: Is acceptance_criteria an array (not a string)?

# DO NOT proceed to next artifact if this fails!
```

### After Each Feature Definition

```bash
# 1. Schema validation (MANDATORY - must pass)
./scripts/validate-schemas.sh _instances/{product}/FIRE/feature_definitions/{file}.yaml

# 2. Feature quality check (RECOMMENDED)
./scripts/validate-feature-quality.sh _instances/{product}/FIRE/feature_definitions/{file}.yaml

# 3. Content readiness (INFORMATIONAL)
./scripts/check-content-readiness.sh _instances/{product}/FIRE/feature_definitions/{file}.yaml
```

### Per-Artifact Status Report

Before proceeding to the next artifact, confirm:

| Check | Status | Action if Failed |
|-------|--------|------------------|
| Schema validation | PASS ✓ / FAIL ✗ | STOP - fix errors |
| Feature quality | PASS ✓ / WARN ⚠ | FIX if errors, note warnings |
| Content grade | A-F | Note for later enrichment |

**Only proceed to next artifact when schema validation PASSES.**

---

## Post-Migration Validation

After migrating all feature definitions, run these checks:

### Required Checks (Must Pass)

```bash
# 1. Schema validation - all files must pass
./scripts/validate-schemas.sh _instances/{product}/FIRE/feature_definitions/

# 2. Feature quality validation - checks persona count, narrative lengths
./scripts/validate-feature-quality.sh _instances/{product}/FIRE/feature_definitions/

# 3. Version alignment - all should show CURRENT
./scripts/check-version-alignment.sh _instances/{product}/
```

### Content Quality Assessment

```bash
# Check content readiness after migration
./scripts/check-content-readiness.sh _instances/{product}/FIRE/feature_definitions/

# This will show:
# - Grade (A-F) for each feature definition
# - Template patterns that may need more specific content
# - Persona narratives that could be enriched
# - Scenarios that need more detail
```

**What to Expect:**
- **Grade B or higher**: Good migration, minor improvements optional
- **Grade C**: Acceptable, but narratives may be generic
- **Grade D or F**: Significant template content - needs human review

### Understanding Post-Migration Status

Migration ensures **structural compliance**:
- ✅ 4 personas with required fields
- ✅ Scenarios at top-level with 8 required fields
- ✅ Schema validation passes

Content quality may still need attention:
- ⚠️ AI-generated narratives may be generic
- ⚠️ Persona names/situations may not match your actual users
- ⚠️ Acceptance criteria may need domain expertise

**The content readiness check helps identify what needs human review.**

---

## Support

If you encounter issues during migration:

1. Check validation errors: `./scripts/validate-schemas.sh {file} --verbose`
2. Compare against schema: `cat schemas/feature_definition_schema.json`
3. Review example files in `definitions/product/`
4. Consult [MIGRATIONS.md](../MIGRATIONS.md) for general guidance
