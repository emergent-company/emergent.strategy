#!/bin/bash
set -e

# ANSI color codes
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Parse command line arguments
MODE="${1:-provision}"

# Show help if requested
if [ "$MODE" = "--help" ] || [ "$MODE" = "-h" ]; then
    echo -e "${BLUE}Zitadel Bootstrap Script (Fully Automated)${NC}"
    echo ""
    echo "Usage: $0 [MODE]"
    echo ""
    echo "Modes:"
    echo "  provision    - Full setup: create org, project, service accounts (default)"
    echo "  status       - Show current configuration and verify connectivity"
    echo "  regenerate   - Regenerate service account JWT keys"
    echo "  help         - Show this help message"
    echo ""
    echo "Environment Variables:"
    echo "  ZITADEL_DOMAIN     - Zitadel domain (default: localhost:8200)"
    echo "  ORG_NAME           - Organization name (default: Spec Organization)"
    echo "  PROJECT_NAME       - Project name (default: Spec Server)"
    echo ""
    echo "Examples:"
    echo "  $0                              # Full provision"
    echo "  $0 status                       # Check configuration"
    echo "  $0 regenerate                   # Regenerate keys"
    echo "  ZITADEL_DOMAIN=auth.example.com $0 provision"
    echo ""
    exit 0
fi

echo -e "${BLUE}═══════════════════════════════════════════════════════════════${NC}"
echo -e "${BLUE}  Zitadel Bootstrap Script - Mode: ${MODE}${NC}"
echo -e "${BLUE}═══════════════════════════════════════════════════════════════${NC}"
echo ""

# Check for automatic PAT file
PAT_FILE="./secrets/bootstrap/pat.txt"

echo -e "${BLUE}[1/10] Looking for automatic PAT...${NC}"

if [ -f "$PAT_FILE" ]; then
    echo -e "${GREEN}✓ Found automatic PAT file!${NC}"
    ADMIN_PAT=$(cat "$PAT_FILE" | tr -d '\n\r')
    
    if [ -z "$ADMIN_PAT" ]; then
        echo -e "${RED}Error: PAT file is empty${NC}"
        exit 1
    fi
    
    echo -e "${GREEN}✓ PAT loaded automatically (zero-touch setup!)${NC}"
    echo -e "${BLUE}This PAT was generated automatically during Zitadel initialization.${NC}"
    echo ""
else
    echo -e "${YELLOW}⚠ No automatic PAT found at ${PAT_FILE}${NC}"
    echo -e "${YELLOW}This usually means:${NC}"
    echo -e "${YELLOW}  1. You're running this script on a Zitadel instance that wasn't initialized with automatic PAT${NC}"
    echo -e "${YELLOW}  2. The PAT file was moved or deleted${NC}"
    echo ""
    echo -e "${YELLOW}Falling back to manual PAT creation...${NC}"
    echo ""
    echo -e "To use this script, you need a Personal Access Token from Zitadel."
    echo -e "Personal Access Tokens can only be created for machine users (service accounts)."
    echo ""
    echo -e "${BLUE}Manual PAT Creation Steps:${NC}"
    echo -e "1. Open ${BLUE}${BASE_URL}${NC}"
    echo -e "2. Login with your admin credentials"
    echo -e "3. Go to Organization Settings → Users"
    echo -e "4. Click + New → Service User"
    echo -e "5. Create a service user with admin permissions"
    echo -e "6. In the service user's settings, go to Personal Access Tokens"
    echo -e "7. Click + New Token"
    echo -e "8. Give it a name and set expiration (or leave empty for no expiration)"
    echo -e "9. Click Create and copy the token"
    echo ""
    read -sp "Paste the Personal Access Token here: " ADMIN_PAT
    echo ""
    
    if [ -z "$ADMIN_PAT" ]; then
        echo -e "${RED}Error: No PAT provided${NC}"
        exit 1
    fi
fi

# Configuration
ZITADEL_DOMAIN="${ZITADEL_DOMAIN:-localhost:8200}"
ORG_NAME="${ORG_NAME:-Spec Organization}"
PROJECT_NAME="${PROJECT_NAME:-Spec Server}"

# Determine protocol
if [[ "$ZITADEL_DOMAIN" == "localhost"* ]] || [[ "$ZITADEL_DOMAIN" == "127.0.0.1"* ]]; then
    PROTOCOL="http"
else
    PROTOCOL="https"
fi

BASE_URL="${PROTOCOL}://${ZITADEL_DOMAIN}"

# Function to load PAT
load_pat() {
    local PAT_FILE="./secrets/bootstrap/pat.txt"
    
    if [ -f "$PAT_FILE" ]; then
        echo -e "${GREEN}✓ Found automatic PAT file!${NC}"
        ADMIN_PAT=$(cat "$PAT_FILE" | tr -d '\n\r')
        
        if [ -z "$ADMIN_PAT" ]; then
            echo -e "${RED}Error: PAT file is empty${NC}"
            exit 1
        fi
        
        echo -e "${GREEN}✓ PAT loaded automatically${NC}"
        return 0
    else
        echo -e "${YELLOW}⚠ No automatic PAT found at ${PAT_FILE}${NC}"
        echo ""
        echo -e "${BLUE}Manual PAT Creation Steps:${NC}"
        echo -e "1. Open ${BLUE}${BASE_URL}${NC}"
        echo -e "2. Login with your admin credentials"
        echo -e "3. Go to Organization Settings → Users"
        echo -e "4. Click + New → Service User"
        echo -e "5. Create a service user with admin permissions"
        echo -e "6. In the service user's settings, go to Personal Access Tokens"
        echo -e "7. Click + New Token"
        echo -e "8. Copy the token"
        echo ""
        read -sp "Paste the Personal Access Token here: " ADMIN_PAT
        echo ""
        
        if [ -z "$ADMIN_PAT" ]; then
            echo -e "${RED}Error: No PAT provided${NC}"
            exit 1
        fi
        return 0
    fi
}

# Function to test authentication
test_auth() {
    TEST_RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
        -H "Authorization: Bearer ${ADMIN_PAT}" \
        -H "Content-Type: application/json" \
        -d '{}' \
        "${BASE_URL}/admin/v1/orgs/_search")

    HTTP_CODE=$(echo "$TEST_RESPONSE" | tail -n1)

    if [ "$HTTP_CODE" != "200" ]; then
        echo -e "${RED}Error: Authentication failed (HTTP $HTTP_CODE)${NC}"
        echo -e "${RED}Response: $(echo "$TEST_RESPONSE" | sed '$d')${NC}"
        return 1
    fi
    
    echo -e "${GREEN}✓ Authentication successful${NC}"
    return 0
}

# Function to get organization ID
get_org_id() {
    ORGS_RESPONSE=$(curl -s -X POST \
        -H "Authorization: Bearer ${ADMIN_PAT}" \
        -H "Content-Type: application/json" \
        -d '{}' \
        "${BASE_URL}/admin/v1/orgs/_search")

    ORG_ID=$(echo "$ORGS_RESPONSE" | jq -r ".result[] | select(.name == \"${ORG_NAME}\") | .id" | head -n1)
}

# Function to get project ID
get_project_id() {
    PROJECTS_RESPONSE=$(curl -s -X POST \
        -H "Authorization: Bearer ${ADMIN_PAT}" \
        -H "Content-Type: application/json" \
        -H "x-zitadel-orgid: ${ORG_ID}" \
        -d '{}' \
        "${BASE_URL}/management/v1/projects/_search")

    PROJECT_ID=$(echo "$PROJECTS_RESPONSE" | jq -r ".result[] | select(.name == \"${PROJECT_NAME}\") | .id" | head -n1)
}

# Function to get service account IDs
get_service_account_ids() {
    USERS_RESPONSE=$(curl -s -X POST \
        -H "Authorization: Bearer ${ADMIN_PAT}" \
        -H "Content-Type: application/json" \
        -H "x-zitadel-orgid: ${ORG_ID}" \
        -d '{}' \
        "${BASE_URL}/management/v1/users/_search")

    CLIENT_USER_ID=$(echo "$USERS_RESPONSE" | jq -r '.result[] | select(.userName == "client-introspection-service") | .id' | head -n1)
    API_USER_ID=$(echo "$USERS_RESPONSE" | jq -r '.result[] | select(.userName == "api-management-service") | .id' | head -n1)
}

# MODE: STATUS
if [ "$MODE" = "status" ]; then
    echo -e "${BLUE}Checking configuration status...${NC}"
    echo ""
    
    # Check local files
    echo -e "${BLUE}Local Files:${NC}"
    
    if [ -f "./secrets/bootstrap/pat.txt" ]; then
        PAT_SIZE=$(wc -c < "./secrets/bootstrap/pat.txt" | tr -d ' ')
        echo -e "  ${GREEN}✓${NC} Bootstrap PAT: ${PAT_SIZE} bytes"
    else
        echo -e "  ${RED}✗${NC} Bootstrap PAT: Not found"
    fi
    
    if [ -f "./secrets/zitadel-client-service-account.json" ]; then
        CLIENT_USER_ID_LOCAL=$(jq -r '.userId' ./secrets/zitadel-client-service-account.json 2>/dev/null)
        CLIENT_KEY_ID_LOCAL=$(jq -r '.keyId' ./secrets/zitadel-client-service-account.json 2>/dev/null)
        echo -e "  ${GREEN}✓${NC} CLIENT key: User ${CLIENT_USER_ID_LOCAL}, Key ${CLIENT_KEY_ID_LOCAL}"
    else
        echo -e "  ${RED}✗${NC} CLIENT key: Not found"
    fi
    
    if [ -f "./secrets/zitadel-api-service-account.json" ]; then
        API_USER_ID_LOCAL=$(jq -r '.userId' ./secrets/zitadel-api-service-account.json 2>/dev/null)
        API_KEY_ID_LOCAL=$(jq -r '.keyId' ./secrets/zitadel-api-service-account.json 2>/dev/null)
        echo -e "  ${GREEN}✓${NC} API key: User ${API_USER_ID_LOCAL}, Key ${API_KEY_ID_LOCAL}"
    else
        echo -e "  ${RED}✗${NC} API key: Not found"
    fi
    
    echo ""
    echo -e "${BLUE}Zitadel Configuration:${NC}"
    echo -e "  Domain: ${ZITADEL_DOMAIN}"
    echo -e "  Base URL: ${BASE_URL}"
    echo -e "  Org Name: ${ORG_NAME}"
    echo -e "  Project Name: ${PROJECT_NAME}"
    echo ""
    
    # Try to connect and verify
    if [ -f "./secrets/bootstrap/pat.txt" ]; then
        echo -e "${BLUE}Verifying Zitadel connectivity...${NC}"
        load_pat
        
        if test_auth; then
            get_org_id
            if [ -n "$ORG_ID" ] && [ "$ORG_ID" != "null" ]; then
                echo -e "  ${GREEN}✓${NC} Organization '${ORG_NAME}': ${ORG_ID}"
                
                get_project_id
                if [ -n "$PROJECT_ID" ] && [ "$PROJECT_ID" != "null" ]; then
                    echo -e "  ${GREEN}✓${NC} Project '${PROJECT_NAME}': ${PROJECT_ID}"
                    
                    get_service_account_ids
                    if [ -n "$CLIENT_USER_ID" ] && [ "$CLIENT_USER_ID" != "null" ]; then
                        echo -e "  ${GREEN}✓${NC} CLIENT service account: ${CLIENT_USER_ID}"
                    else
                        echo -e "  ${RED}✗${NC} CLIENT service account: Not found"
                    fi
                    
                    if [ -n "$API_USER_ID" ] && [ "$API_USER_ID" != "null" ]; then
                        echo -e "  ${GREEN}✓${NC} API service account: ${API_USER_ID}"
                    else
                        echo -e "  ${RED}✗${NC} API service account: Not found"
                    fi
                else
                    echo -e "  ${RED}✗${NC} Project '${PROJECT_NAME}': Not found"
                fi
            else
                echo -e "  ${RED}✗${NC} Organization '${ORG_NAME}': Not found"
            fi
        fi
    else
        echo -e "${YELLOW}⚠ Cannot verify without PAT file${NC}"
    fi
    
    echo ""
    echo -e "${BLUE}Environment Variables for .env:${NC}"
    if [ -n "$ORG_ID" ] && [ "$ORG_ID" != "null" ]; then
        echo "ZITADEL_DOMAIN=${ZITADEL_DOMAIN}"
        echo "ZITADEL_ORG_ID=${ORG_ID}"
        if [ -n "$PROJECT_ID" ] && [ "$PROJECT_ID" != "null" ]; then
            echo "ZITADEL_PROJECT_ID=${PROJECT_ID}"
        fi
    else
        echo -e "${YELLOW}# Run provision mode first to get IDs${NC}"
    fi
    echo "ZITADEL_CLIENT_JWT_PATH=./secrets/zitadel-client-service-account.json"
    echo "ZITADEL_API_JWT_PATH=./secrets/zitadel-api-service-account.json"
    
    exit 0
fi

# MODE: REGENERATE
if [ "$MODE" = "regenerate" ]; then
    echo -e "${BLUE}Regenerating service account JWT keys...${NC}"
    echo ""
    
    load_pat
    echo ""
    
    echo -e "${BLUE}Testing authentication...${NC}"
    if ! test_auth; then
        exit 1
    fi
    echo ""
    
    echo -e "${BLUE}Getting organization...${NC}"
    get_org_id
    if [ -z "$ORG_ID" ] || [ "$ORG_ID" = "null" ]; then
        echo -e "${RED}Error: Organization '${ORG_NAME}' not found${NC}"
        echo -e "${YELLOW}Run 'provision' mode first to create the organization${NC}"
        exit 1
    fi
    echo -e "${GREEN}✓ Organization found: ${ORG_ID}${NC}"
    echo ""
    
    echo -e "${BLUE}Getting service accounts...${NC}"
    get_service_account_ids
    
    if [ -z "$CLIENT_USER_ID" ] || [ "$CLIENT_USER_ID" = "null" ]; then
        echo -e "${RED}Error: CLIENT service account not found${NC}"
        echo -e "${YELLOW}Run 'provision' mode first to create service accounts${NC}"
        exit 1
    fi
    
    if [ -z "$API_USER_ID" ] || [ "$API_USER_ID" = "null" ]; then
        echo -e "${RED}Error: API service account not found${NC}"
        echo -e "${YELLOW}Run 'provision' mode first to create service accounts${NC}"
        exit 1
    fi
    
    echo -e "${GREEN}✓ CLIENT service account: ${CLIENT_USER_ID}${NC}"
    echo -e "${GREEN}✓ API service account: ${API_USER_ID}${NC}"
    echo ""
    
    # Regenerate CLIENT key
    echo -e "${BLUE}Regenerating CLIENT JWT key...${NC}"
    CLIENT_KEY_RESPONSE=$(curl -s -X POST \
        -H "Authorization: Bearer ${ADMIN_PAT}" \
        -H "Content-Type: application/json" \
        -H "x-zitadel-orgid: ${ORG_ID}" \
        -d '{
            "type": "KEY_TYPE_JSON",
            "expirationDate": "2030-01-01T00:00:00Z"
        }' \
        "${BASE_URL}/management/v1/users/${CLIENT_USER_ID}/keys")

    CLIENT_KEY_DETAILS=$(echo "$CLIENT_KEY_RESPONSE" | jq -r '.keyDetails')

    if [ -z "$CLIENT_KEY_DETAILS" ] || [ "$CLIENT_KEY_DETAILS" = "null" ]; then
        echo -e "${RED}Error: Failed to generate CLIENT key${NC}"
        echo -e "${RED}Response: $CLIENT_KEY_RESPONSE${NC}"
        exit 1
    fi

    mkdir -p secrets
    echo "$CLIENT_KEY_DETAILS" | base64 -d > secrets/zitadel-client-service-account.json
    echo -e "${GREEN}✓ CLIENT key regenerated and saved${NC}"
    
    # Regenerate API key
    echo -e "${BLUE}Regenerating API JWT key...${NC}"
    API_KEY_RESPONSE=$(curl -s -X POST \
        -H "Authorization: Bearer ${ADMIN_PAT}" \
        -H "Content-Type: application/json" \
        -H "x-zitadel-orgid: ${ORG_ID}" \
        -d '{
            "type": "KEY_TYPE_JSON",
            "expirationDate": "2030-01-01T00:00:00Z"
        }' \
        "${BASE_URL}/management/v1/users/${API_USER_ID}/keys")

    API_KEY_DETAILS=$(echo "$API_KEY_RESPONSE" | jq -r '.keyDetails')

    if [ -z "$API_KEY_DETAILS" ] || [ "$API_KEY_DETAILS" = "null" ]; then
        echo -e "${RED}Error: Failed to generate API key${NC}"
        echo -e "${RED}Response: $API_KEY_RESPONSE${NC}"
        exit 1
    fi

    echo "$API_KEY_DETAILS" | base64 -d > secrets/zitadel-api-service-account.json
    echo -e "${GREEN}✓ API key regenerated and saved${NC}"
    echo ""
    
    echo -e "${GREEN}═══════════════════════════════════════════════════════════${NC}"
    echo -e "${GREEN}   Keys Regenerated Successfully!${NC}"
    echo -e "${GREEN}═══════════════════════════════════════════════════════════${NC}"
    echo ""
    echo -e "${YELLOW}Next steps:${NC}"
    echo "1. Restart your server to load the new keys"
    echo "2. Old keys will be invalid immediately"
    echo ""
    
    exit 0
fi

# MODE: PROVISION (default)
if [ "$MODE" != "provision" ]; then
    echo -e "${RED}Error: Unknown mode '${MODE}'${NC}"
    echo "Run '$0 --help' for usage information"
    exit 1
fi

echo ""

echo -e "${BLUE}Configuration:${NC}"
echo -e "  Domain: ${ZITADEL_DOMAIN}"
echo -e "  Base URL: ${BASE_URL}"
echo -e "  Org: ${ORG_NAME}"
echo -e "  Project: ${PROJECT_NAME}"
echo ""

# Test authentication
echo -e "${BLUE}[2/10] Testing authentication...${NC}"
TEST_RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
    -H "Authorization: Bearer ${ADMIN_PAT}" \
    -H "Content-Type: application/json" \
    -d '{}' \
    "${BASE_URL}/admin/v1/orgs/_search")

HTTP_CODE=$(echo "$TEST_RESPONSE" | tail -n1)

if [ "$HTTP_CODE" != "200" ]; then
    echo -e "${RED}Error: Authentication failed (HTTP $HTTP_CODE)${NC}"
    echo -e "${RED}Response: $(echo "$TEST_RESPONSE" | sed '$d')${NC}"
    exit 1
fi

echo -e "${GREEN}✓ Authentication successful${NC}"

# Now continue with the standard bootstrap process
echo -e "\n${BLUE}[3/10] Listing organizations...${NC}"
ORGS_RESPONSE=$(curl -s -X POST \
    -H "Authorization: Bearer ${ADMIN_PAT}" \
    -H "Content-Type: application/json" \
    -d '{}' \
    "${BASE_URL}/admin/v1/orgs/_search")

# Check if our org exists
ORG_ID=$(echo "$ORGS_RESPONSE" | jq -r ".result[] | select(.name == \"${ORG_NAME}\") | .id" | head -n1)

if [ -n "$ORG_ID" ]; then
    echo -e "${GREEN}✓ Organization '${ORG_NAME}' already exists (ID: ${ORG_ID})${NC}"
else
    echo -e "${YELLOW}Creating organization '${ORG_NAME}'...${NC}"
    
    ORG_CREATE_RESPONSE=$(curl -s -X POST \
        -H "Authorization: Bearer ${ADMIN_PAT}" \
        -H "Content-Type: application/json" \
        -d "{\"name\": \"${ORG_NAME}\"}" \
        "${BASE_URL}/v2/organizations")
    
    ORG_ID=$(echo "$ORG_CREATE_RESPONSE" | jq -r '.organizationId')
    
    if [ -z "$ORG_ID" ] || [ "$ORG_ID" = "null" ]; then
        echo -e "${RED}Error: Failed to create organization${NC}"
        echo -e "${RED}Response: $ORG_CREATE_RESPONSE${NC}"
        exit 1
    fi
    
    echo -e "${GREEN}✓ Organization created (ID: ${ORG_ID})${NC}"
fi

echo -e "\n${BLUE}[4/10] Checking for existing project...${NC}"
PROJECTS_RESPONSE=$(curl -s -X POST \
    -H "Authorization: Bearer ${ADMIN_PAT}" \
    -H "Content-Type: application/json" \
    -H "x-zitadel-orgid: ${ORG_ID}" \
    -d '{}' \
    "${BASE_URL}/management/v1/projects/_search")

PROJECT_ID=$(echo "$PROJECTS_RESPONSE" | jq -r ".result[] | select(.name == \"${PROJECT_NAME}\") | .id" | head -n1)

if [ -n "$PROJECT_ID" ] && [ "$PROJECT_ID" != "null" ]; then
    echo -e "${GREEN}✓ Project '${PROJECT_NAME}' already exists (ID: ${PROJECT_ID})${NC}"
else
    echo -e "${YELLOW}Creating project '${PROJECT_NAME}'...${NC}"
    PROJECT_CREATE_RESPONSE=$(curl -s -X POST \
        -H "Authorization: Bearer ${ADMIN_PAT}" \
        -H "Content-Type: application/json" \
        -H "x-zitadel-orgid: ${ORG_ID}" \
        -d "{\"name\": \"${PROJECT_NAME}\"}" \
        "${BASE_URL}/management/v1/projects")

    PROJECT_ID=$(echo "$PROJECT_CREATE_RESPONSE" | jq -r '.id')

    if [ -z "$PROJECT_ID" ] || [ "$PROJECT_ID" = "null" ]; then
        echo -e "${RED}Error: Failed to create project${NC}"
        echo -e "${RED}Response: $PROJECT_CREATE_RESPONSE${NC}"
        exit 1
    fi

    echo -e "${GREEN}✓ Project created (ID: ${PROJECT_ID})${NC}"
fi

# Create CLIENT service account
echo -e "\n${BLUE}[5/10] Creating CLIENT service account (for introspection)...${NC}"
CLIENT_USER_RESPONSE=$(curl -s -X POST \
    -H "Authorization: Bearer ${ADMIN_PAT}" \
    -H "Content-Type: application/json" \
    -H "x-zitadel-orgid: ${ORG_ID}" \
    -d '{
        "userName": "client-introspection-service",
        "name": "Client Introspection Service",
        "description": "Service account for token introspection (minimal permissions)",
        "accessTokenType": "ACCESS_TOKEN_TYPE_JWT"
    }' \
    "${BASE_URL}/management/v1/users/machine")

CLIENT_USER_ID=$(echo "$CLIENT_USER_RESPONSE" | jq -r '.userId')

if [ -z "$CLIENT_USER_ID" ] || [ "$CLIENT_USER_ID" = "null" ]; then
    echo -e "${RED}Error: Failed to create CLIENT service account${NC}"
    echo -e "${RED}Response: $CLIENT_USER_RESPONSE${NC}"
    exit 1
fi

echo -e "${GREEN}✓ CLIENT service account created (ID: ${CLIENT_USER_ID})${NC}"

# Generate CLIENT JWT key
echo -e "\n${BLUE}[6/10] Generating CLIENT JWT key...${NC}"
CLIENT_KEY_RESPONSE=$(curl -s -X POST \
    -H "Authorization: Bearer ${ADMIN_PAT}" \
    -H "Content-Type: application/json" \
    -H "x-zitadel-orgid: ${ORG_ID}" \
    -d '{
        "type": "KEY_TYPE_JSON",
        "expirationDate": "2030-01-01T00:00:00Z"
    }' \
    "${BASE_URL}/management/v1/users/${CLIENT_USER_ID}/keys")

CLIENT_KEY_ID=$(echo "$CLIENT_KEY_RESPONSE" | jq -r '.id')
CLIENT_KEY_DETAILS=$(echo "$CLIENT_KEY_RESPONSE" | jq -r '.keyDetails')

if [ -z "$CLIENT_KEY_DETAILS" ] || [ "$CLIENT_KEY_DETAILS" = "null" ]; then
    echo -e "${RED}Error: Failed to generate CLIENT key${NC}"
    echo -e "${RED}Response: $CLIENT_KEY_RESPONSE${NC}"
    exit 1
fi

# Save CLIENT key
mkdir -p secrets
echo "$CLIENT_KEY_DETAILS" | base64 -d > secrets/zitadel-client-service-account.json
echo -e "${GREEN}✓ CLIENT key saved to secrets/zitadel-client-service-account.json${NC}"

# Create API service account
echo -e "\n${BLUE}[7/10] Creating API service account (for Management API)...${NC}"
API_USER_RESPONSE=$(curl -s -X POST \
    -H "Authorization: Bearer ${ADMIN_PAT}" \
    -H "Content-Type: application/json" \
    -H "x-zitadel-orgid: ${ORG_ID}" \
    -d '{
        "userName": "api-management-service",
        "name": "API Management Service",
        "description": "Service account for Management API operations (elevated permissions)",
        "accessTokenType": "ACCESS_TOKEN_TYPE_JWT"
    }' \
    "${BASE_URL}/management/v1/users/machine")

API_USER_ID=$(echo "$API_USER_RESPONSE" | jq -r '.userId')

if [ -z "$API_USER_ID" ] || [ "$API_USER_ID" = "null" ]; then
    echo -e "${RED}Error: Failed to create API service account${NC}"
    echo -e "${RED}Response: $API_USER_RESPONSE${NC}"
    exit 1
fi

echo -e "${GREEN}✓ API service account created (ID: ${API_USER_ID})${NC}"

# Grant ORG_OWNER role to API service account
echo -e "\n${BLUE}[8/10] Granting ORG_OWNER role to API service account...${NC}"
GRANT_RESPONSE=$(curl -s -X POST \
    -H "Authorization: Bearer ${ADMIN_PAT}" \
    -H "Content-Type: application/json" \
    -H "x-zitadel-orgid: ${ORG_ID}" \
    -d "{\"userId\": \"${API_USER_ID}\", \"roles\": [\"ORG_OWNER\"]}" \
    "${BASE_URL}/management/v1/orgs/me/members")

echo -e "${GREEN}✓ Role granted${NC}"

# Generate API JWT key
echo -e "\n${BLUE}[9/10] Generating API JWT key...${NC}"
API_KEY_RESPONSE=$(curl -s -X POST \
    -H "Authorization: Bearer ${ADMIN_PAT}" \
    -H "Content-Type: application/json" \
    -H "x-zitadel-orgid: ${ORG_ID}" \
    -d '{
        "type": "KEY_TYPE_JSON",
        "expirationDate": "2030-01-01T00:00:00Z"
    }' \
    "${BASE_URL}/management/v1/users/${API_USER_ID}/keys")

API_KEY_ID=$(echo "$API_KEY_RESPONSE" | jq -r '.id')
API_KEY_DETAILS=$(echo "$API_KEY_RESPONSE" | jq -r '.keyDetails')

if [ -z "$API_KEY_DETAILS" ] || [ "$API_KEY_DETAILS" = "null" ]; then
    echo -e "${RED}Error: Failed to generate API key${NC}"
    echo -e "${RED}Response: $API_KEY_RESPONSE${NC}"
    exit 1
fi

# Save API key
echo "$API_KEY_DETAILS" | base64 -d > secrets/zitadel-api-service-account.json
echo -e "${GREEN}✓ API key saved to secrets/zitadel-api-service-account.json${NC}"

# Output configuration
echo -e "\n${BLUE}[10/10] Configuration complete!${NC}"
echo -e "\n${GREEN}═══════════════════════════════════════════════════════════${NC}"
echo -e "${GREEN}   Setup Complete - Add to your .env file:${NC}"
echo -e "${GREEN}═══════════════════════════════════════════════════════════${NC}"
echo ""
echo "# Zitadel Configuration"
echo "ZITADEL_DOMAIN=${ZITADEL_DOMAIN}"
echo "ZITADEL_ORG_ID=${ORG_ID}"
echo "ZITADEL_PROJECT_ID=${PROJECT_ID}"
echo ""
echo "# CLIENT Service Account (for introspection)"
echo "ZITADEL_CLIENT_JWT_PATH=./secrets/zitadel-client-service-account.json"
echo ""
echo "# API Service Account (for Management API)"
echo "ZITADEL_API_JWT_PATH=./secrets/zitadel-api-service-account.json"
echo ""
echo -e "${GREEN}═══════════════════════════════════════════════════════════${NC}"
echo ""
echo -e "${BLUE}Next steps:${NC}"
echo "1. Add the above configuration to your .env file"
echo "2. Restart your server: ${BLUE}npm run workspace:restart${NC}"
echo "3. Look for: ${GREEN}'Dual service account mode active'${NC} in logs"
echo ""
echo -e "${YELLOW}Security Note:${NC}"
echo "The admin PAT used for bootstrap can now be deleted from Zitadel."
echo "Your application will use the service account JWT keys instead."
echo ""
