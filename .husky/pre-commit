#!/usr/bin/env sh

# Pre-commit hook to validate SQL migration syntax

echo "üîç Checking SQL migration files for syntax errors..."

# Get list of staged SQL migration files
MIGRATION_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '^apps/server-nest/migrations/.*\.sql$' || true)

if [ -z "$MIGRATION_FILES" ]; then
  echo "‚úì No migration files to check"
  exit 0
fi

ERRORS=0

for file in $MIGRATION_FILES; do
  echo "Checking: $file"
  
  # Check for invalid backslash metacommands
  if grep -q '^\\' "$file"; then
    echo "‚ùå ERROR: Found backslash metacommand in $file"
    echo "   SQL migrations should not contain psql metacommands (lines starting with \\)"
    grep -n '^\\' "$file"
    ERRORS=$((ERRORS + 1))
  fi
  
  # Check for spaced dollar quotes
  if grep -q '\$ \$' "$file"; then
    echo "‚ùå ERROR: Found spaced dollar quotes in $file"
    echo "   Dollar quotes should be $$ not $ $"
    grep -n '\$ \$' "$file" | head -5
    ERRORS=$((ERRORS + 1))
  fi
done

if [ $ERRORS -gt 0 ]; then
  echo ""
  echo "‚ùå Found $ERRORS error(s) in SQL migration files"
  echo "Please fix the issues above before committing"
  exit 1
fi

echo "‚úÖ All SQL migration files look good!"
exit 0
