services:
  # Infisical secrets loader
  # Fetches secrets from Infisical and exports as environment variables
  # Services depend on this to get their configuration
  infisical-secrets:
    image: infisical/cli:0.31.4-alpine
    env_file:
      - .env
    environment:
      - INFISICAL_TOKEN=${INFISICAL_TOKEN_DEV}
    command: export --format=dotenv-export --log-level=error
    profiles:
      - infisical
    # No ports, no volumes needed - just exports env vars

  db:
    image: pgvector/pgvector:pg16
    depends_on:
      - infisical-secrets
    environment:
      - POSTGRES_USER=${POSTGRES_USER:-spec}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-spec}
      - POSTGRES_DB=${POSTGRES_DB:-spec}
      - ZITADEL_DB_PASSWORD=${ZITADEL_DB_PASSWORD:-zitadel}
    ports:
      - "${POSTGRES_PORT:-5432}:5432"
    volumes:
      - pg_data:/var/lib/postgresql/data
      - ./init.sql:/docker-entrypoint-initdb.d/00-init.sql:ro
      - ./01-init-zitadel.sh:/docker-entrypoint-initdb.d/01-init-zitadel.sh:ro
      - ${DB_LOGS_PATH:-/home/emergent/db_logs}:/var/log/postgresql
    command: >
      postgres
      -c log_destination=stderr
      -c logging_collector=on
      -c log_directory=/var/log/postgresql
      -c log_filename=postgresql-%Y-%m-%d.log
      -c log_rotation_age=1d
      -c log_truncate_on_rotation=on
      -c log_statement=${POSTGRES_LOG_STATEMENT:-none}
      -c log_connections=on
      -c log_disconnections=on
      -c log_duration=off
      -c log_line_prefix='%t [%p] %u@%d '
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "pg_isready -U ${POSTGRES_USER:-spec} -d ${POSTGRES_DB:-spec}",
        ]
      interval: 5s
      timeout: 5s
      retries: 10

  # Zitadel Identity Provider (dev)
  zitadel:
    image: ghcr.io/zitadel/zitadel:latest
    depends_on:
      infisical-secrets:
        condition: service_completed_successfully
      db:
        condition: service_healthy
    env_file:
      - ./zitadel.env
    command: ["start-from-init", "--masterkeyFromEnv"]
    ports:
      - "${ZITADEL_HTTP_PORT:-8100}:8080" # Zitadel HTTP (API) - configurable to avoid conflicts
      - "${ZITADEL_LOGIN_PORT:-8101}:3000" # Zitadel Login v2 (Next.js) - configurable
    labels:
      - "traefik.enable=true"
      # HTTP router (redirects to HTTPS)
      - "traefik.http.routers.zitadel.rule=Host(`${ZITADEL_EXTERNALDOMAIN}`)"
      - "traefik.http.routers.zitadel.entrypoints=web"
      # HTTPS router
      - "traefik.http.routers.zitadel-https.rule=Host(`${ZITADEL_EXTERNALDOMAIN}`)"
      - "traefik.http.routers.zitadel-https.entrypoints=websecure"
      - "traefik.http.routers.zitadel-https.tls=true"
      - "traefik.http.routers.zitadel-https.tls.certresolver=letsencrypt"
      # Service configuration (required for both HTTP and HTTPS)
      - "traefik.http.services.zitadel.loadbalancer.server.port=8080"
      - "traefik.http.routers.zitadel.service=zitadel"
      - "traefik.http.routers.zitadel-https.service=zitadel"
    healthcheck:
      test: ["CMD", "/app/zitadel", "ready"]
      interval: 10s
      timeout: 60s
      retries: 5
      start_period: 10s
    user: "0"
    volumes:
      - .:/current-dir:delegated
      - ../secrets/bootstrap:/machinekey

  login:
    image: ghcr.io/zitadel/zitadel-login:latest
    restart: unless-stopped
    environment:
      - ZITADEL_API_URL=http://localhost:${ZITADEL_HTTP_PORT:-8100}
      - NEXT_PUBLIC_BASE_PATH=/ui/v2/login
      - ZITADEL_SERVICE_USER_TOKEN_FILE=/current-dir/login-client.pat
    volumes:
      - .:/current-dir:ro
    network_mode: service:zitadel
    depends_on:
      zitadel:
        condition: service_healthy
volumes:
  pg_data:
  db_logs:
