# E2E Test Database - Ephemeral Setup
# This database is designed to be destroyed and recreated for each test run
# Ports and data are completely isolated from dev/production databases

services:
  db-e2e:
    image: pgvector/pgvector:pg16
    container_name: spec-e2e-db
    environment:
      POSTGRES_USER: spec
      POSTGRES_PASSWORD: spec
      POSTGRES_DB: spec_e2e
    ports:
      - '5438:5432' # Different port to avoid conflicts with dev DB (5437)
    volumes:
      # Use init.sql from parent docker/ directory for schema setup
      - ./init.sql:/docker-entrypoint-initdb.d/00-init.sql:ro
      # NO persistent volume - data is ephemeral
    healthcheck:
      test: ['CMD-SHELL', 'pg_isready -U spec -d spec_e2e']
      interval: 2s
      timeout: 3s
      retries: 10
    # Optimizations for faster test execution
    command: >
      postgres
      -c fsync=off
      -c synchronous_commit=off
      -c full_page_writes=off
      -c shared_buffers=256MB
      -c max_connections=100
    # Optional: Add restart policy if you want to keep it running
    # restart: unless-stopped

  migrate-e2e:
    image: node:20-alpine
    container_name: spec-e2e-migrations
    working_dir: /app
    volumes:
      - ../:/app:ro # Mount entire project as read-only
      - /app/node_modules # Use container's node_modules
    environment:
      POSTGRES_HOST: db-e2e
      POSTGRES_PORT: 5432 # Internal Docker network port
      POSTGRES_USER: spec
      POSTGRES_PASSWORD: spec
      POSTGRES_DB: spec_e2e
      NODE_ENV: test
    depends_on:
      db-e2e:
        condition: service_healthy
    command: >
      sh -c "
      npm install &&
      cd apps/server-nest &&
      NODE_OPTIONS='--import tsx' npx typeorm migration:run -d src/typeorm.config.ts
      "
    restart: 'no' # Run once and exit
