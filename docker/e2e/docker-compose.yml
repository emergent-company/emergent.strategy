# E2E Test Database - Ephemeral Setup
# This database is designed to be destroyed and recreated for each test run
# Ports and data are completely isolated from dev/production databases
# Containers are automatically prefixed with 'e2e-' due to folder structure

services:
  db:
    image: pgvector/pgvector:pg16
    environment:
      POSTGRES_USER: spec
      POSTGRES_PASSWORD: spec
      POSTGRES_DB: spec_e2e
    ports:
      - '5438:5432' # Different port to avoid conflicts with dev DB (5437)
    volumes:
      # Use init.sql from parent docker/ directory for schema setup
      - ../init.sql:/docker-entrypoint-initdb.d/00-init.sql:ro
      # NO persistent volume - data is ephemeral
    healthcheck:
      test: ['CMD-SHELL', 'pg_isready -U spec -d spec_e2e']
      interval: 2s
      timeout: 3s
      retries: 10
    # Optimizations for faster test execution
    command: >
      postgres
      -c fsync=off
      -c synchronous_commit=off
      -c full_page_writes=off
      -c shared_buffers=256MB
      -c max_connections=100
